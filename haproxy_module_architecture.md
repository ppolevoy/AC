# Архитектура модуля управления HAProxy для AC

## Краткое описание

Модуль предназначен для централизованного управления серверами в бэкендах HAProxy через сервис AC. Обеспечивает асинхронный сбор информации о статусах серверов и отправку команд управления (ready, maint, drain).

## Основные функции

### 1. Мониторинг и синхронизация
- **Периодический опрос HAProxy** (раз в минуту, настраиваемо)
  - Получение списка бэкендов и серверов через FAgent API
  - Автоматическое сопоставление с приложениями в AC
  - Отслеживание появления/исчезновения серверов
  - Приоритет данных из HAProxy при расхождениях

### 2. Управление состоянием серверов
- **Команды управления**:
  - `drain` - плавный вывод из балансировки (завершение текущих соединений)
  - `maint` - полный вывод в обслуживание
  - `ready` - возврат в работу
- **Гарантии доставки**:
  - Idempotent операции через transaction_id
  - Retry с exponential backoff
  - Circuit breaker (3 ошибки, 1 минута восстановления)

### 3. Сопоставление приложений
- **Алгоритм маппинга**:
  1. По IP:port если указан порт у приложения
  2. По имени сервера (шаблон: `{hostname}_{app_name}_{instance}`)
- **Кеширование** для обработки переименований бэкендов

### 4. Аудит и история
- **Логирование всех действий**:
  - Кто и когда выполнил команду
  - История изменения статусов
  - Результаты выполнения команд
- **Таблица actions** с полным аудит-трейлом

### 5. Интеграция с существующей системой
- **Task Queue** для асинхронного выполнения команд
- **ApplicationGroup** для batch операций
- **SSH/Ansible** для будущей интеграции с процессом обновления
- **Настройка серверов** с флагом "Узел с HAProxy"

## Структура БД

### Новые таблицы

#### haproxy_instances
- Хранит информацию об экземплярах HAProxy
- Связь с сервером через флаг `is_haproxy_node`
- Circuit breaker состояние

#### haproxy_backends
- Список бэкендов каждого HAProxy
- Уникальность по (haproxy_id, backend_name)

#### haproxy_servers
- Серверы в бэкендах с их статусами
- Связь с приложениями через application_id
- Soft delete через removed_at

#### haproxy_actions
- Журнал всех команд управления
- Transaction ID для идемпотентности
- Статусы: pending → running → success/failed

#### haproxy_server_status_history
- История изменений статусов
- Кто и когда изменил
- Предыдущее состояние

## API Endpoints

### Мониторинг
- `GET /api/haproxy/instances` - список HAProxy инстансов
- `GET /api/haproxy/instances/{id}/backends` - бэкенды инстанса
- `GET /api/haproxy/backends/{id}/servers` - серверы в бэкенде
- `GET /api/haproxy/servers/{id}/history` - история статусов

### Управление
- `POST /api/haproxy/servers/{id}/action` - выполнить действие
- `POST /api/haproxy/instances/{id}/sync` - принудительная синхронизация
- `POST /api/haproxy/batch/action` - групповая операция

### Настройка
- `PUT /api/servers/{id}/haproxy` - настройка HAProxy на сервере

## Процессы

### 1. Периодическая синхронизация
```
Каждую минуту:
1. Опросить все активные HAProxy через FAgent
2. Сравнить с данными в БД
3. Обновить статусы, создать новые записи
4. Пометить removed_at для исчезнувших
5. Записать изменения в историю
```

### 2. Выполнение команды
```
1. Создать запись в haproxy_actions
2. Проверить circuit breaker
3. Отправить команду через FAgent API
4. Retry при ошибке (до 3 раз)
5. Обновить статус выполнения
6. Записать в историю статусов
```

### 3. Обработка новых серверов
```
1. Обнаружен новый сервер в HAProxy
2. Создать запись в haproxy_servers
3. Попытаться найти соответствующее приложение
4. Связать если найдено
5. Записать в журнал событий
```

## Обработка ошибок

### Circuit Breaker
- **Порог**: 3 последовательные ошибки
- **Восстановление**: через 1 минуту
- **Состояния**: closed → open → half-open

### Retry Policy
- **Максимум попыток**: 3
- **Backoff**: exponential (1s, 2s, 4s)
- **Идемпотентность**: через transaction_id

### Расхождение данных
- **Приоритет**: всегда у HAProxy
- **Force Sync**: ручная синхронизация по требованию

## Безопасность

### Контроль доступа
- Настраиваемые права на операции (будущее)
- Логирование всех действий с указанием актора
- Валидация команд перед выполнением

### Изоляция
- Каждый HAProxy доступен только через свой FAgent
- Нет cross-agent доступа
- Блокировка операций при недоступности агента

## Расширяемость

### Заложено на будущее
1. **Автоматизация при обновлении**
   - drain → update → ready workflow
   - Интеграция с Ansible playbooks

2. **Webhooks**
   - Уведомления при изменении статусов
   - Callback URLs для внешних систем

3. **Мониторинг**
   - Метрики для Prometheus
   - Алерты при критических событиях

4. **Роли и права**
   - Разграничение доступа к операциям
   - Approval workflow для критичных действий

## Производительность

### Оптимизации
- Индексы на часто используемые поля
- Пагинация для больших списков
- Кеширование маппинга приложений
- Асинхронное выполнение команд

### Масштабируемость
- До 100+ серверов на бэкенд
- До 10 HAProxy инстансов
- История за последние 30 дней (настраиваемо)

## Миграция данных

При развертывании:
1. Создание новых таблиц через Alembic
2. Добавление полей в существующие таблицы
3. Начальная синхронизация с HAProxy
4. Автоматический маппинг существующих приложений

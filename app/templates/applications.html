{% extends "base.html" %}

{% block title %}Faktura Apps - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è{% endblock %}

{% block page_title %}–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="cluster-info">
    <div class="server-dropdown">
        <button class="dropdown-button" id="server-selected">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä <span>‚ñæ</span></button>
        <div class="dropdown-content" id="server-list">
            <a href="#" data-server-id="all">–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã</a>
            <!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
    
    <hr>
    
    <div class="search-container">
        <div class="search-bar">
            <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è" id="search-input" class="search-input">
            <span class="search-icon">üîç</span>
        </div>
        <button id="refresh-btn" class="refresh-btn" title="–û–±–Ω–æ–≤–∏—Ç—å">‚ü≥</button>
    </div>
    
    <div class="action-buttons">
        <button class="action-btn start" id="start-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        <button class="action-btn restart" id="restart-btn">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
        <button class="action-btn stop" id="stop-btn">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button class="action-btn" id="update-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="action-btn" id="unload-btn">–°–Ω—è—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É</button>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>
                        <div class="header-checkbox-container">
                            <label class="custom-checkbox">
                                <input type="checkbox" id="select-all">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </th>
                    <th class="sortable" data-sort="name">–ò–º—è —Å–µ—Ä–≤–∏—Å–∞</th>
                    <th>–í–µ—Ä—Å–∏—è</th>
                    <th class="sortable" data-sort="state">–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–µ—Ä–≤–µ—Ä</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="applications-table-body">
                <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                <tr>
                    <td colspan="6" class="table-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination">
        <div class="page-size">
            <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å</span>
            <select class="page-select" id="page-size-select">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
        <div class="page-nav" id="pagination-controls">
            <div class="page-number">1</div>
            <button class="nav-btn prev-page" disabled>‚óÄ</button>
            <button class="nav-btn next-page">‚ñ∂</button>
        </div>
    </div>
</div>

<!-- –®–∞–±–ª–æ–Ω –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω -->
<template id="update-modal-template">
    <div class="modal-tabs" id="update-tabs">
        <!-- –í–∫–ª–∞–¥–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π -->
    </div>
    <form id="update-form" class="modal-form">
        <div class="form-group">
            <label for="distr-url">URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞:</label>
            <input type="text" id="distr-url" name="distr-url" class="form-control" required>
        </div>
        <div class="form-group">
            <label>–†–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="restart-mode" value="restart" checked> –í —Ä–µ—Å—Ç–∞—Ä—Ç
                </label>
                <label class="radio-label">
                    <input type="radio" name="restart-mode" value="immediate"> –°–µ–π—á–∞—Å
                </label>
            </div>
        </div>
        <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="submit-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </form>
</template>

<template id="confirm-action-modal-template">
    <p class="confirmation-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ <span class="action-name"></span> –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?</p>
    <div class="app-list"></div>
    <div class="form-actions">
        <button type="button" class="cancel-btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="confirm-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
</template>

<template id="app-info-modal-template">
    <div class="app-info-container">
        <div class="app-info-section">
            <h4>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
            <table class="info-table">
                <tr>
                    <td class="info-label">–ò–º—è:</td>
                    <td class="app-name"></td>
                </tr>
                <tr>
                    <td class="info-label">–¢–∏–ø:</td>
                    <td class="app-type"></td>
                </tr>
                <tr>
                    <td class="info-label">–°—Ç–∞—Ç—É—Å:</td>
                    <td class="app-status"></td>
                </tr>
                <tr>
                    <td class="info-label">–í–µ—Ä—Å–∏—è:</td>
                    <td class="app-version"></td>
                </tr>
                <tr>
                    <td class="info-label">–°–µ—Ä–≤–µ—Ä:</td>
                    <td class="app-server"></td>
                </tr>
                <tr>
                    <td class="info-label">IP:</td>
                    <td class="app-ip"></td>
                </tr>
                <tr>
                    <td class="info-label">–ü–æ—Ä—Ç:</td>
                    <td class="app-port"></td>
                </tr>
            </table>
        </div>
        
        <div class="app-info-section">
            <h4>–ü—É—Ç–∏ –∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h4>
            <table class="info-table">
                <tr>
                    <td class="info-label">–ü—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</td>
                    <td class="app-path"></td>
                </tr>
                <tr>
                    <td class="info-label">–ü—É—Ç—å –∫ –ª–æ–≥–∞–º:</td>
                    <td class="app-log-path"></td>
                </tr>
                <tr>
                    <td class="info-label">–ü—É—Ç—å –∫ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—É:</td>
                    <td class="app-distr-path"></td>
                </tr>
            </table>
        </div>
        
        <div class="app-info-section">
            <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h4>
            <div class="form-group">
                <label for="update-playbook-path">–ü—É—Ç—å –∫ Ansible playbook:</label>
                <div class="input-with-button">
                    <input type="text" id="update-playbook-path" class="form-control app-playbook-path">
                    <button type="button" id="save-playbook-path" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
        
        <div class="app-info-section">
            <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h4>
            <div class="events-list"></div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        let allApplications = [];
        let filteredApplications = [];
        let currentPage = 1;
        let pageSize = 10;
        let selectedServerId = 'all';
        let sortColumn = 'name';
        let sortDirection = 'asc';
        let searchQuery = '';
        
        // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
        const serverDropdown = document.getElementById('server-selected');
        const serverList = document.getElementById('server-list');
        const searchInput = document.getElementById('search-input');
        const refreshBtn = document.getElementById('refresh-btn');
        const selectAllCheckbox = document.getElementById('select-all');
        const applicationsTableBody = document.getElementById('applications-table-body');
        const pageSizeSelect = document.getElementById('page-size-select');
        const paginationControls = document.getElementById('pagination-controls');
        
        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const stopBtn = document.getElementById('stop-btn');
        const updateBtn = document.getElementById('update-btn');
        const unloadBtn = document.getElementById('unload-btn');
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        async function loadServers() {
            try {
                const response = await fetch('/api/servers');
                const data = await response.json();
                
                if (data.success) {
                    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤
                    while (serverList.children.length > 1) {
                        serverList.removeChild(serverList.lastChild);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä—ã –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                    data.servers.forEach(server => {
                        const serverItem = document.createElement('a');
                        serverItem.setAttribute('href', '#');
                        serverItem.setAttribute('data-server-id', server.id);
                        serverItem.textContent = server.name;
                        
                        serverItem.addEventListener('click', function(e) {
                            e.preventDefault();
                            selectServer(server.id, server.name);
                        });
                        
                        serverList.appendChild(serverItem);
                    });
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤:', data.error);
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤');
            }
        }
        
        // –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        function selectServer(serverId, serverName) {
            selectedServerId = serverId;
            serverDropdown.innerHTML = `${serverName || '–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã'} <span>‚ñæ</span>`;
            currentPage = 1;
            loadApplications();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
        async function loadApplications() {
            try {
                applicationsTableBody.innerHTML = '<tr><td colspan="6" class="table-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π...</td></tr>';
                
                // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                let url = '/api/applications';
                const params = new URLSearchParams();
                
                if (selectedServerId !== 'all') {
                    params.append('server_id', selectedServerId);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    allApplications = data.applications;
                    filterAndDisplayApplications();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:', data.error);
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π');
                    applicationsTableBody.innerHTML = '<tr><td colspan="6" class="table-loading error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</td></tr>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π');
                applicationsTableBody.innerHTML = '<tr><td colspan="6" class="table-loading error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</td></tr>';
            }
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
        function filterAndDisplayApplications() {
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filteredApplications = allApplications.filter(app => 
                    app.name.toLowerCase().includes(query) || 
                    (app.version && app.version.toLowerCase().includes(query)) ||
                    (app.server_name && app.server_name.toLowerCase().includes(query))
                );
            } else {
                filteredApplications = [...allApplications];
            }
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            filteredApplications.sort((a, b) => {
                let valueA, valueB;
                
                if (sortColumn === 'name') {
                    valueA = a.name.toLowerCase();
                    valueB = b.name.toLowerCase();
                } else if (sortColumn === 'state') {
                    valueA = a.status ? a.status.toLowerCase() : '';
                    valueB = b.status ? b.status.toLowerCase() : '';
                }
                
                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const totalPages = Math.ceil(filteredApplications.length / pageSize);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredApplications.length);
            const displayedApplications = filteredApplications.slice(startIndex, endIndex);
            
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–∞–±–ª–∏—Ü—É
            applicationsTableBody.innerHTML = '';
            
            if (displayedApplications.length === 0) {
                applicationsTableBody.innerHTML = '<tr><td colspan="6" class="table-loading">–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏—è–º –ø–æ–∏—Å–∫–∞</td></tr>';
                updatePagination(0);
                return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
            displayedApplications.forEach(app => {
                const row = document.createElement('tr');
                
                // –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                const statusDot = app.status === 'online' ? 
                    '<span class="service-dot"></span>' : 
                    '<span class="service-dot offline"></span>';
                
                row.innerHTML = `
                    <td>
                        <div class="checkbox-container">
                            <label class="custom-checkbox">
                                <input type="checkbox" class="app-checkbox" data-app-id="${app.id}">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </td>
                    <td class="service-name">
                        ${app.name}
                        <div class="dist-details">
                            <div>–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: ${app.start_time ? new Date(app.start_time).toLocaleString() : '–ù/–î'}</div>
                            <div>–¢–∏–ø: ${app.type || '–ù/–î'}</div>
                        </div>
                    </td>
                    <td>${app.version || '–ù/–î'}</td>
                    <td>${statusDot}</td>
                    <td>${app.server_name || '–ù/–î'}</td>
                    <td>
                        <div class="actions-menu">
                            <button class="actions-button">...</button>
                            <div class="actions-dropdown">
                                <a href="#" class="app-info-btn" data-app-id="${app.id}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a>
                                <a href="#" class="app-start-btn" data-app-id="${app.id}">–ó–∞–ø—É—Å—Ç–∏—Ç—å</a>
                                <a href="#" class="app-stop-btn" data-app-id="${app.id}">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</a>
                                <a href="#" class="app-restart-btn" data-app-id="${app.id}">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</a>
                                <a href="#" class="app-update-btn" data-app-id="${app.id}">–û–±–Ω–æ–≤–∏—Ç—å</a>
                            </div>
                        </div>
                    </td>
                `;
                
                applicationsTableBody.appendChild(row);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            updatePagination(totalPages);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–∞–±–ª–∏—Ü—ã
            setupTableEventHandlers();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        function updatePagination(totalPages) {
            const pageNumberElement = paginationControls.querySelector('.page-number');
            const prevButton = paginationControls.querySelector('.prev-page');
            const nextButton = paginationControls.querySelector('.next-page');
            
            if (totalPages === 0) {
                pageNumberElement.textContent = '0';
                prevButton.disabled = true;
                nextButton.disabled = true;
                return;
            }
            
            pageNumberElement.textContent = currentPage;
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            prevButton.onclick = function() {
                if (currentPage > 1) {
                    currentPage--;
                    filterAndDisplayApplications();
                }
            };
            
            nextButton.onclick = function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    filterAndDisplayApplications();
                }
            };
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–∞–±–ª–∏—Ü—ã
        function setupTableEventHandlers() {
            // –†–∞—Å–∫—Ä—ã—Ç–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
            document.querySelectorAll('tbody tr').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (e.target.closest('.checkbox-container') || e.target.closest('.actions-menu')) {
                        return;
                    }
                    this.classList.toggle('expanded');
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ–∫–±–æ–∫—Å–æ–≤
            const appCheckboxes = document.querySelectorAll('.app-checkbox');
            appCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectAllState);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º –º–µ–Ω—é
            document.querySelectorAll('.app-info-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const appId = this.getAttribute('data-app-id');
                    showAppInfoModal(appId);
                });
            });
            
            document.querySelectorAll('.app-start-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const appId = this.getAttribute('data-app-id');
                    showConfirmActionModal([appId], 'start');
                });
            });
            
            document.querySelectorAll('.app-stop-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const appId = this.getAttribute('data-app-id');
                    showConfirmActionModal([appId], 'stop');
                });
            });
            
            document.querySelectorAll('.app-restart-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const appId = this.getAttribute('data-app-id');
                    showConfirmActionModal([appId], 'restart');
                });
            });
            
            document.querySelectorAll('.app-update-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const appId = this.getAttribute('data-app-id');
                    showUpdateModal([appId]);
                });
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
        function updateSelectAllState() {
            const appCheckboxes = document.querySelectorAll('.app-checkbox');
            const checkedCount = document.querySelectorAll('.app-checkbox:checked').length;
            
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === appCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
            
            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
            updateActionButtonsState(checkedCount > 0);
        }
        
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        function updateActionButtonsState(hasSelection) {
            startBtn.disabled = !hasSelection;
            restartBtn.disabled = !hasSelection;
            stopBtn.disabled = !hasSelection;
            updateBtn.disabled = !hasSelection;
            unloadBtn.disabled = !hasSelection;
            
            // –î–æ–±–∞–≤–ª—è–µ–º/—É–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
            [startBtn, restartBtn, stopBtn, updateBtn, unloadBtn].forEach(btn => {
                if (hasSelection) {
                    btn.classList.remove('disabled');
                } else {
                    btn.classList.add('disabled');
                }
            });
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
        function getSelectedAppIds() {
            const selectedCheckboxes = document.querySelectorAll('.app-checkbox:checked');
            return Array.from(selectedCheckboxes).map(checkbox => checkbox.getAttribute('data-app-id'));
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ ID
        function getAppById(appId) {
            return allApplications.find(app => app.id == appId);
        }
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
		async function showAppInfoModal(appId) {
			try {
				const response = await fetch(`/api/applications/${appId}`);
				const data = await response.json();
				
				if (!data.success) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:', data.error);
					showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
					return;
				}
				
				const app = data.application;
				
				// –ö–ª–æ–Ω–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
				const modalTemplate = document.getElementById('app-info-modal-template');
				const modalContent = document.importNode(modalTemplate.content, true);
				
				// –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
				modalContent.querySelector('.app-name').textContent = app.name;
				modalContent.querySelector('.app-type').textContent = app.app_type || '–ù–µ —É–∫–∞–∑–∞–Ω';
				modalContent.querySelector('.app-status').textContent = app.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
				modalContent.querySelector('.app-version').textContent = app.version || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
				modalContent.querySelector('.app-server').textContent = app.server_name || '–ù–µ —É–∫–∞–∑–∞–Ω';
				modalContent.querySelector('.app-ip').textContent = app.ip || '–ù–µ —É–∫–∞–∑–∞–Ω';
				modalContent.querySelector('.app-port').textContent = app.port || '–ù–µ —É–∫–∞–∑–∞–Ω';
				modalContent.querySelector('.app-path').textContent = app.path || '–ù–µ —É–∫–∞–∑–∞–Ω';
				modalContent.querySelector('.app-log-path').textContent = app.log_path || '–ù–µ —É–∫–∞–∑–∞–Ω';
				modalContent.querySelector('.app-distr-path').textContent = app.distr_path || '–ù–µ —É–∫–∞–∑–∞–Ω';
				
				// –ü—É—Ç—å –∫ playbook –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
				const playbookInput = modalContent.querySelector('.app-playbook-path');
				playbookInput.value = app.update_playbook_path || '';
				
				// –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π
				const eventsList = modalContent.querySelector('.events-list');
				if (app.events && app.events.length > 0) {
					const eventsTable = document.createElement('table');
					eventsTable.className = 'events-table';
					
					// –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
					const headerRow = document.createElement('tr');
					headerRow.innerHTML = `
						<th>–î–∞—Ç–∞</th>
						<th>–¢–∏–ø</th>
						<th>–°—Ç–∞—Ç—É—Å</th>
					`;
					eventsTable.appendChild(headerRow);
					
					// –°—Ç—Ä–æ–∫–∏ —Å —Å–æ–±—ã—Ç–∏—è–º–∏
					app.events.forEach(event => {
						const eventRow = document.createElement('tr');
						eventRow.className = `event-row ${event.status}`;
						
						const eventDate = new Date(event.timestamp);
						
						eventRow.innerHTML = `
							<td>${eventDate.toLocaleString()}</td>
							<td>${event.event_type}</td>
							<td>${event.status}</td>
						`;
						
						eventRow.setAttribute('title', event.description || '');
						eventsTable.appendChild(eventRow);
					});
					
					eventsList.appendChild(eventsTable);
				} else {
					eventsList.innerHTML = '<p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Å–æ–±—ã—Ç–∏—è—Ö</p>';
				}
				
				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É—Ç–∏ –∫ playbook
				const savePlaybookBtn = modalContent.querySelector('#save-playbook-path');
				savePlaybookBtn.addEventListener('click', async function() {
					const playbookPath = playbookInput.value.trim();
					
					try {
						const response = await fetch(`/api/applications/${appId}/update_playbook`, {
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								playbook_path: playbookPath
							})
						});
						
						const data = await response.json();
						
						if (data.success) {
							showNotification('–ü—É—Ç—å –∫ –ø–ª–µ–π–±—É–∫—É —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
						} else {
							console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—É—Ç–∏ –∫ –ø–ª–µ–π–±—É–∫—É:', data.error);
							showError(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—É—Ç—å –∫ –ø–ª–µ–π–±—É–∫—É');
						}
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—É—Ç–∏ –∫ –ø–ª–µ–π–±—É–∫—É:', error);
						showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—É—Ç—å –∫ –ø–ª–µ–π–±—É–∫—É');
					}
				});
				
				// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
				window.showModal(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: ${app.name}`, modalContent);
				
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:', error);
				showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
			}
		}
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è
		function showConfirmActionModal(appIds, action) {
			if (!appIds || appIds.length === 0) {
				showError('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
				return;
			}
			
			// –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
			const actionNames = {
				'start': '–∑–∞–ø—É—Å—Ç–∏—Ç—å',
				'stop': '–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
				'restart': '–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å'
			};
			
			const actionName = actionNames[action] || action;
			
			// –ö–ª–æ–Ω–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
			const modalTemplate = document.getElementById('confirm-action-modal-template');
			const modalContent = document.importNode(modalTemplate.content, true);
			
			// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
			modalContent.querySelector('.action-name').textContent = actionName;
			
			// –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
			const appList = modalContent.querySelector('.app-list');
			const appListUl = document.createElement('ul');
			
			appIds.forEach(appId => {
				const app = getAppById(appId);
				if (app) {
					const li = document.createElement('li');
					li.textContent = `${app.name} (${app.server_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–µ—Ä–≤–µ—Ä'})`;
					appListUl.appendChild(li);
				}
			});
			
			appList.appendChild(appListUl);
			
			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
			const confirmBtn = modalContent.querySelector('.confirm-btn');
			confirmBtn.textContent = `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (${appIds.length})`;
			
			confirmBtn.addEventListener('click', async function() {
				try {
					const response = await fetch('/api/applications/bulk/manage', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							action: action,
							app_ids: appIds
						})
					});
					
					const data = await response.json();
					
					if (data.success) {
						window.closeModal();
						
						// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
						const successCount = data.results.filter(r => r.success).length;
						const errorCount = data.results.length - successCount;
						
						if (errorCount === 0) {
							showNotification(`–î–µ–π—Å—Ç–≤–∏–µ "${actionName}" —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
						} else if (successCount === 0) {
							showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ "${actionName}" –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
						} else {
							showNotification(`–î–µ–π—Å—Ç–≤–∏–µ "${actionName}" –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è ${successCount} –∏–∑ ${data.results.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
						}
						
						// –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
						loadApplications();
					} else {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è:', data.error);
						showError(data.error || `–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ "${actionName}"`);
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è:', error);
					showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ "${actionName}"`);
				}
			});
			
			// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
			window.showModal(`${actionName.charAt(0).toUpperCase() + actionName.slice(1)} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è`, modalContent);
		}
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
		function showUpdateModal(appIds) {
			if (!appIds || appIds.length === 0) {
				showError('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
				return;
			}
			
			// –ö–ª–æ–Ω–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
			const modalTemplate = document.getElementById('update-modal-template');
			const modalContent = document.importNode(modalTemplate.content, true);
			
			const updateForm = modalContent.querySelector('#update-form');
			const tabsContainer = modalContent.querySelector('#update-tabs');
			
			// –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ,
			// —Å–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
			if (appIds.length > 1) {
				const appGroups = {};
				
				// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
				appIds.forEach(appId => {
					const app = getAppById(appId);
					if (app) {
						const groupName = app.group_name || app.name;
						if (!appGroups[groupName]) {
							appGroups[groupName] = [];
						}
						appGroups[groupName].push(app);
					}
				});
				
				// –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥—Ä—É–ø–ø, —Å–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
				if (Object.keys(appGroups).length > 1) {
					// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
					tabsContainer.style.display = 'flex';
					
					// –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
					Object.keys(appGroups).forEach((groupName, index) => {
						const tab = document.createElement('div');
						tab.className = `modal-tab ${index === 0 ? 'active' : ''}`;
						tab.textContent = groupName;
						tab.setAttribute('data-group', groupName);
						tabsContainer.appendChild(tab);
						
						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –≤–∫–ª–∞–¥–∫–µ
						tab.addEventListener('click', function() {
							const activeTab = tabsContainer.querySelector('.modal-tab.active');
							if (activeTab) {
								activeTab.classList.remove('active');
							}
							tab.classList.add('active');
							
							// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
							updateFormForGroup(groupName);
						});
					});
					
					// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
					function updateFormForGroup(groupName) {
						const apps = appGroups[groupName];
						const appIds = apps.map(app => app.id);
						
						// –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
						let appIdsInput = updateForm.querySelector('input[name="app-ids"]');
						if (!appIdsInput) {
							appIdsInput = document.createElement('input');
							appIdsInput.type = 'hidden';
							appIdsInput.name = 'app-ids';
							updateForm.appendChild(appIdsInput);
						}
						appIdsInput.value = appIds.join(',');
						
						// –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã
						const formTitle = updateForm.querySelector('.form-title');
						if (formTitle) {
							formTitle.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${apps.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≥—Ä—É–ø–ø—ã "${groupName}"`;
						}
						
						// –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—É—Ç—å –∫ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
						const firstApp = apps[0];
						if (firstApp && firstApp.distr_path) {
							const distrUrlInput = updateForm.querySelector('#distr-url');
							if (distrUrlInput) {
								distrUrlInput.value = firstApp.distr_path;
								distrUrlInput.placeholder = 'URL –∏–ª–∏ –ø—É—Ç—å –∫ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—É';
							}
						}
					}
					
					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –ø–µ—Ä–≤–æ–π –≥—Ä—É–ø–ø—ã
					updateFormForGroup(Object.keys(appGroups)[0]);
				} else {
					// –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é —Ñ–æ—Ä–º—É
					setupSingleUpdateForm(appIds);
				}
			} else {
				// –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é —Ñ–æ—Ä–º—É
				setupSingleUpdateForm(appIds);
			}
			
			// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã
			function setupSingleUpdateForm(appIds) {
				// –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
				tabsContainer.style.display = 'none';
				
				// –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
				const appIdsInput = document.createElement('input');
				appIdsInput.type = 'hidden';
				appIdsInput.name = 'app-ids';
				appIdsInput.value = appIds.join(',');
				updateForm.appendChild(appIdsInput);
				
				// –ï—Å–ª–∏ —ç—Ç–æ –æ–¥–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—É—Ç—å –∫ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
				if (appIds.length === 1) {
					const app = getAppById(appIds[0]);
					if (app && app.distr_path) {
						const distrUrlInput = updateForm.querySelector('#distr-url');
						if (distrUrlInput) {
							distrUrlInput.value = app.distr_path;
							distrUrlInput.placeholder = 'URL –∏–ª–∏ –ø—É—Ç—å –∫ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—É';
						}
					}
				}
			}
			
			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
			updateForm.addEventListener('submit', async function(e) {
				e.preventDefault();
				
				const appIdsInput = updateForm.querySelector('input[name="app-ids"]');
				const distrUrlInput = updateForm.querySelector('#distr-url');
				const restartModeInputs = updateForm.querySelectorAll('input[name="restart-mode"]');
				
				if (!appIdsInput || !distrUrlInput) {
					showError('–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
					return;
				}
				
				const appIds = appIdsInput.value.split(',').map(id => parseInt(id.trim()));
				const distrUrl = distrUrlInput.value.trim();
				
				let restartMode = 'restart'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
				for (const input of restartModeInputs) {
					if (input.checked) {
						restartMode = input.value;
						break;
					}
				}
				
				if (!distrUrl) {
					showError('–£–∫–∞–∂–∏—Ç–µ URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞');
					return;
				}
				
				try {
					// –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
					const updatePromises = appIds.map(appId => 
						fetch(`/api/applications/${appId}/update`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								distr_url: distrUrl,
								restart_mode: restartMode
							})
						}).then(response => response.json())
					);
					
					// –ñ–¥–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
					const results = await Promise.all(updatePromises);
					
					// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
					const successCount = results.filter(result => result.success).length;
					const errorCount = results.length - successCount;
					
					// –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
					window.closeModal();
					
					if (errorCount === 0) {
						showNotification(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
					} else if (successCount === 0) {
						showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
					} else {
						showNotification(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –¥–ª—è ${successCount} –∏–∑ ${results.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
					}
					
					// –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
					loadApplications();
					
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:', error);
					showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π');
				}
			});
			
			// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
			const title = appIds.length === 1 ? 
				`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${getAppById(appIds[0])?.name || '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'}` : 
				`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${appIds.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`;
			
			window.showModal(title, modalContent);
		}
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 5000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function initEventHandlers() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
            selectAllCheckbox.addEventListener('change', function() {
                const appCheckboxes = document.querySelectorAll('.app-checkbox');
                appCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateActionButtonsState(this.checked);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
            searchInput.addEventListener('input', function() {
                searchQuery = this.value.trim();
                currentPage = 1;
                filterAndDisplayApplications();
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            pageSizeSelect.addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                filterAndDisplayApplications();
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            refreshBtn.addEventListener('click', function() {
                this.classList.add('rotating');
                loadApplications().finally(() => {
                    this.classList.remove('rotating');
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const currentSortColumn = sortColumn;
                    sortColumn = this.getAttribute('data-sort');
                    
                    if (currentSortColumn === sortColumn) {
                        // –ú–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
                        sortDirection = 'asc';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    document.querySelectorAll('th.sortable').forEach(header => {
                        header.classList.remove('sorted-asc', 'sorted-desc');
                    });
                    
                    this.classList.add(`sorted-${sortDirection}`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
                    filterAndDisplayApplications();
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
            startBtn.addEventListener('click', function() {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    showConfirmActionModal(selectedAppIds, 'start');
                }
            });
            
            restartBtn.addEventListener('click', function() {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    showConfirmActionModal(selectedAppIds, 'restart');
                }
            });
            
            stopBtn.addEventListener('click', function() {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    showConfirmActionModal(selectedAppIds, 'stop');
                }
            });
            
            updateBtn.addEventListener('click', function() {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    showUpdateModal(selectedAppIds);
                }
            });
            
            unloadBtn.addEventListener('click', function() {
                showNotification('–§—É–Ω–∫—Ü–∏—è "–°–Ω—è—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function init() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é
            loadServers();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
            loadApplications();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            initEventHandlers();
            
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            updateActionButtonsState(false);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        init();
    });
</script>
{% endblock %}

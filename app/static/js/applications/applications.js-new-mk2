/**
 * Faktura Apps - –ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏
 * –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
 */

document.addEventListener('DOMContentLoaded', function() {
    'use strict';

    // ========================================
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
    // ========================================
    let allApplications = [];
    let filteredApplications = [];
    let currentPage = 1;
    let pageSize = 10;
    let selectedServerId = 'all';
    let sortColumn = 'name';
    let sortDirection = 'asc';
    let searchQuery = '';
    let groupingEnabled = true;
    let activeDropdown = null;
    let dropdownOverlay = null;
    let expandedGroups = [];

    // –ö—ç—à –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
    const artifactsCache = {};
    const CACHE_LIFETIME = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    const LOADING_CONFIG = {
        MIN_LOADING_TIME: 800,
        PROGRESS_STEPS: {
            FETCH_START: 30,
            FETCH_COMPLETE: 70,
            PARSE_COMPLETE: 100
        },
        CACHE_LIFETIME: 5 * 60 * 1000,
        ANIMATION_DELAYS: {
            FADE_IN: 100,
            FIELD_STAGGER: 100
        }
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const selectedItemsState = {
        applications: new Set(),
        groups: new Set()
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const serverDropdown = document.getElementById('server-selected');
    const serverList = document.getElementById('server-list');
    const searchInput = document.getElementById('search-input');
    const refreshBtn = document.getElementById('refresh-btn');
    const selectAllCheckbox = document.getElementById('select-all');
    const applicationsTableBody = document.getElementById('applications-table-body');
    const pageSizeSelect = document.getElementById('page-size-select');
    const paginationControls = document.getElementById('pagination-controls');
    
    // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const stopBtn = document.getElementById('stop-btn');
    const updateBtn = document.getElementById('update-btn');
    const unloadBtn = document.getElementById('unload-btn');

    // ========================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ========================================
    init();
    initClickDropdowns();

    function init() {
        loadServers();
        loadApplications();
        initDropdownHandlers();

        const groupToggleBtn = document.getElementById('group-toggle-btn');
        if (groupToggleBtn) {
            groupingEnabled = groupToggleBtn.classList.contains('active');
            
            groupToggleBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                groupingEnabled = this.classList.contains('active');
                currentPage = 1;
                filterAndDisplayApplications();
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                
                if (isChecked) {
                    document.querySelectorAll('.app-checkbox').forEach(checkbox => {
                        checkbox.checked = true;
                        const appId = checkbox.getAttribute('data-app-id');
                        if (appId) selectedItemsState.applications.add(appId);
                    });
                    
                    document.querySelectorAll('.group-checkbox').forEach(checkbox => {
                        checkbox.checked = true;
                        const groupName = checkbox.getAttribute('data-group');
                        if (groupName) selectedItemsState.groups.add(groupName);
                    });
                } else {
                    clearCheckboxState();
                    document.querySelectorAll('.app-checkbox, .group-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                }
                
                updateActionButtonsState();
            });
        }

        // –ü–æ–∏—Å–∫
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                searchQuery = this.value;
                currentPage = 1;
                filterAndDisplayApplications();
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        if (refreshBtn) {
            refreshBtn.addEventListener('click', loadApplications);
        }

        // –†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                filterAndDisplayApplications();
            });
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        document.querySelectorAll('th.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                
                document.querySelectorAll('th.sortable').forEach(h => {
                    h.classList.remove('sorted-asc', 'sorted-desc');
                });
                
                this.classList.add(`sorted-${sortDirection}`);
                filterAndDisplayApplications();
            });
        });

        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        if (startBtn) {
            startBtn.addEventListener('click', () => {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    showConfirmActionModal(selectedAppIds, 'start');
                }
            });
        }

        if (restartBtn) {
            restartBtn.addEventListener('click', () => {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    showConfirmActionModal(selectedAppIds, 'restart');
                }
            });
        }

        if (stopBtn) {
            stopBtn.addEventListener('click', () => {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    showConfirmActionModal(selectedAppIds, 'stop');
                }
            });
        }

        if (updateBtn) {
            updateBtn.addEventListener('click', () => {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    showUpdateModal(selectedAppIds);
                }
            });
        }

        if (unloadBtn) {
            unloadBtn.addEventListener('click', () => {
                const selectedAppIds = getSelectedAppIds();
                if (selectedAppIds.length > 0) {
                    handleBulkAction(selectedAppIds, 'unload');
                }
            });
        }
    }

    // ========================================
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–´–ü–ê–î–ê–Æ–©–ò–ú–ò –ú–ï–ù–Æ
    // ========================================
    function initClickDropdowns() {
        if (!dropdownOverlay) {
            dropdownOverlay = document.createElement('div');
            dropdownOverlay.className = 'dropdown-overlay';
            document.body.appendChild(dropdownOverlay);
            dropdownOverlay.addEventListener('click', closeAllDropdowns);
        }
        
        document.body.addEventListener('click', function(e) {
            const actionButton = e.target.closest('.actions-button');
            if (actionButton) {
                e.preventDefault();
                e.stopPropagation();
                toggleClickDropdown(actionButton);
            }
        });
    }

    function toggleClickDropdown(actionButton) {
        const dropdown = actionButton.nextElementSibling;
        
        if (dropdown.classList.contains('show')) {
            return;
        }
        
        closeAllDropdowns();
        dropdownOverlay.style.display = 'block';
        positionClickDropdown(dropdown, actionButton);
        activeDropdown = dropdown;
    }

    function positionClickDropdown(dropdown, actionButton) {
        const buttonRect = actionButton.getBoundingClientRect();
        const spaceBelow = window.innerHeight - buttonRect.bottom;
        const showUpwards = spaceBelow < 200;
        
        dropdown.style.display = 'block';
        dropdown.style.opacity = '0';
        dropdown.classList.remove('dropdown-up');
        
        if (showUpwards) {
            dropdown.classList.add('dropdown-up');
            dropdown.style.bottom = (window.innerHeight - buttonRect.top) + 'px';
        } else {
            dropdown.style.top = buttonRect.bottom + 'px';
        }
        
        dropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
        dropdown.classList.add('show');
        dropdown.style.opacity = '1';
        actionButton.classList.add('active');
    }

    function closeAllDropdowns() {
        if (dropdownOverlay) {
            dropdownOverlay.style.display = 'none';
        }
        
        document.querySelectorAll('.actions-dropdown.show').forEach(dropdown => {
            dropdown.classList.remove('show');
            dropdown.style.display = '';
            dropdown.style.top = '';
            dropdown.style.right = '';
            dropdown.style.bottom = '';
            
            const parentMenu = dropdown.closest('.actions-menu');
            if (parentMenu) {
                const actionButton = parentMenu.querySelector('.actions-button');
                if (actionButton) {
                    actionButton.classList.remove('active');
                }
            }
        });
        
        activeDropdown = null;
    }

    function initDropdownHandlers() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ dropdown
        const serverDropdownWrapper = document.querySelector('.dropdown-wrapper');
        if (serverDropdownWrapper) {
            serverDropdownWrapper.addEventListener('click', function(e) {
                if (e.target === serverDropdown || serverDropdown.contains(e.target)) {
                    this.classList.toggle('open');
                }
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-wrapper')) {
                document.querySelectorAll('.dropdown-wrapper.open').forEach(wrapper => {
                    wrapper.classList.remove('open');
                });
            }
        });
    }

    // ========================================
    // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    // ========================================
    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            const data = await response.json();

            if (data.success && data.servers) {
                serverList.innerHTML = '';
                
                const allItem = document.createElement('div');
                allItem.className = 'dropdown-item';
                allItem.innerHTML = '–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã';
                allItem.addEventListener('click', () => selectServer('all', '–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã'));
                serverList.appendChild(allItem);

                data.servers.forEach(server => {
                    const serverItem = document.createElement('div');
                    serverItem.className = 'dropdown-item';
                    serverItem.innerHTML = `${server.name} <span class="app-count">(${server.app_count})</span>`;
                    serverItem.addEventListener('click', () => selectServer(server.id, server.name));
                    serverList.appendChild(serverItem);
                });
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤:', data.error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤');
        }
    }

    function selectServer(serverId, serverName) {
        selectedServerId = serverId;
        serverDropdown.innerHTML = `${serverName || '–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã'} <span>‚ñæ</span>`;
        currentPage = 1;
        loadApplications();
    }

    async function loadApplications() {
        clearCheckboxState();
        saveTableState();
        
        try {
            applicationsTableBody.innerHTML = '<tr><td colspan="6" class="table-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π...</td></tr>';
            
            let url = '/api/applications';
            const params = new URLSearchParams();
            
            if (selectedServerId !== 'all') {
                params.append('server_id', selectedServerId);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.applications) {
                allApplications = data.applications;
                filterAndDisplayApplications();
                restoreTableState();
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:', data.error);
                applicationsTableBody.innerHTML = '<tr><td colspan="6" class="table-loading">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</td></tr>';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:', error);
            applicationsTableBody.innerHTML = '<tr><td colspan="6" class="table-loading">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</td></tr>';
        }
    }

    async function loadArtifactsWithCache(appId) {
        const cacheKey = `app_${appId}`;
        const now = Date.now();
        const cacheEntry = artifactsCache[cacheKey];

        if (cacheEntry) {
            const age = now - cacheEntry.timestamp;
            if (age < CACHE_LIFETIME) {
                console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${appId} (–≤–æ–∑—Ä–∞—Å—Ç: ${Math.round(age/1000)}—Å)`);
                return cacheEntry.data;
            }
        }

        try {
            const maxVersions = window.APP_CONFIG?.MAX_ARTIFACTS_DISPLAY || 20;
            const response = await fetch(`/api/applications/${appId}/artifacts?limit=${maxVersions}`);
            const data = await response.json();
            
            if (data.success && data.versions && data.versions.length > 0) {
                const artifacts = data.versions.slice(0, maxVersions);
                
                artifactsCache[cacheKey] = {
                    timestamp: now,
                    data: artifacts
                };
                
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${artifacts.length} –≤–µ—Ä—Å–∏–π –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${appId}`);
                return artifacts;
            }
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${appId}:`, error);
        }
        
        return null;
    }

    // ========================================
    // –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ô
    // ========================================
    function filterAndDisplayApplications() {
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        let filtered = [...allApplications];
        
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(app => 
                app.name?.toLowerCase().includes(query) ||
                app.server_name?.toLowerCase().includes(query) ||
                app.status?.toLowerCase().includes(query) ||
                app.version?.toLowerCase().includes(query)
            );
        }
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        filtered.sort((a, b) => {
            let valueA = a[sortColumn] || '';
            let valueB = b[sortColumn] || '';
            
            if (sortColumn === 'status') {
                valueA = a.status ? a.status.toLowerCase() : '';
                valueB = b.status ? b.status.toLowerCase() : '';
            }
            
            if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
            if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
        
        applicationsTableBody.innerHTML = '';
        
        if (filtered.length === 0) {
            applicationsTableBody.innerHTML = '<tr><td colspan="6" class="table-loading">–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏—è–º –ø–æ–∏—Å–∫–∞</td></tr>';
            updatePagination(0);
            return;
        }
        
        filteredApplications = filtered;
        
        if (groupingEnabled) {
            displayGroupedApplications(filtered);
        } else {
            displayFlatApplications(filtered);
        }
        
        setupTableEventHandlers();
        restoreCheckboxState();
    }

    function displayFlatApplications(applications) {
        const totalPages = Math.ceil(applications.length / pageSize);
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
        }
        
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, applications.length);
        const displayedApplications = applications.slice(startIndex, endIndex);
        
        displayedApplications.forEach(app => {
            const row = createApplicationRow(app, false);
            applicationsTableBody.appendChild(row);
        });
        
        updatePagination(totalPages);
    }

    function displayGroupedApplications(applications) {
        const groups = {};
        
        applications.forEach(app => {
            const groupName = app.group_name || app.name;
            if (!groups[groupName]) {
                groups[groupName] = [];
            }
            groups[groupName].push(app);
        });
        
        const groupEntries = Object.entries(groups).map(([name, apps]) => ({
            name,
            apps,
            count: apps.length
        }));
        
        groupEntries.sort((a, b) => a.name.localeCompare(b.name));
        
        const totalGroups = groupEntries.length;
        const totalPages = Math.ceil(totalGroups / pageSize);
        
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
        }
        
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalGroups);
        const displayedGroups = groupEntries.slice(startIndex, endIndex);
        
        displayedGroups.forEach(group => {
            if (group.count === 1) {
                const appRow = createApplicationRow(group.apps[0], false);
                applicationsTableBody.appendChild(appRow);
                return;
            }
            
            const groupRow = createGroupRow(group.name, group.apps);
            applicationsTableBody.appendChild(groupRow);
            
            const wrapperRow = document.createElement('tr');
            wrapperRow.className = 'child-wrapper';
            wrapperRow.setAttribute('data-group', group.name);
            
            const wrapperCell = document.createElement('td');
            wrapperCell.setAttribute('colspan', '6');
            
            const childContainer = document.createElement('div');
            childContainer.className = 'child-container';
            
            const childTable = document.createElement('table');
            childTable.className = 'child-table';
            
            const childTableBody = document.createElement('tbody');
            
            group.apps.forEach(app => {
                const childRow = document.createElement('tr');
                childRow.className = 'app-child-row';
                childRow.setAttribute('data-app-id', app.id);
                childRow.setAttribute('data-parent', group.name);
                
                const statusDot = app.status === 'online' ? 
                    '<span class="service-dot"></span>' : 
                    '<span class="service-dot offline"></span>';
                
                childRow.innerHTML = `
                    <td>
                        <div class="checkbox-container">
                            <label class="custom-checkbox">
                                <input type="checkbox" class="app-checkbox" data-app-id="${app.id}">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </td>
                    <td class="service-name">
                        ${app.name}
                        <div class="dist-details">
                            <div>–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: ${app.start_time ? new Date(app.start_time).toLocaleString() : '–ù/–î'}</div>
                            <div>–ü—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${app.path || '–ù/–î'}</div>
                            <div>–ü—É—Ç—å –∫ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—É: ${app.distr_path || '–ù/–î'}</div>
                        </div>
                    </td>
                    <td>${app.version || '–ù/–î'}</td>
                    <td>${statusDot} ${app.status}</td>
                    <td>${app.server_name || '–ù/–î'}</td>
                    <td>
                        <div class="actions-menu">
                            <button class="actions-button">...</button>
                            <div class="actions-dropdown">
                                ${createActionMenuItems(app)}
                            </div>
                        </div>
                    </td>
                `;
                
                childRow.addEventListener('click', function(e) {
                    if (e.target.closest('.checkbox-container') || e.target.closest('.actions-menu')) {
                        return;
                    }
                    this.classList.toggle('expanded');
                });
                
                childTableBody.appendChild(childRow);
            });
            
            childTable.appendChild(childTableBody);
            childContainer.appendChild(childTable);
            wrapperCell.appendChild(childContainer);
            wrapperRow.appendChild(wrapperCell);
            
            applicationsTableBody.appendChild(wrapperRow);
        });
        
        setupAppActionButtons();
        setupGroupActionButtons();
        
        updatePagination(totalPages);
    }

    function createGroupRow(groupName, groupApps) {
        const row = document.createElement('tr');
        row.className = 'group-row';
        row.setAttribute('data-group', groupName);
        
        const versions = new Set(groupApps.map(app => app.version || '*'));
        const versionText = versions.size === 1 ? 
            Array.from(versions)[0] : 
            '<span class="version-different">*</span>';
        
        const hasOffline = groupApps.some(app => app.status !== 'online');
        const statusDot = hasOffline ? 
            '<span class="service-dot offline"></span>' : 
            '<span class="service-dot"></span>';
        
        const serverName = groupApps[0].server_name || '–ù/–î';
        
        row.innerHTML = `
            <td>
                <div class="checkbox-container">
                    <label class="custom-checkbox">
                        <input type="checkbox" class="group-checkbox" data-group="${groupName}">
                        <span class="checkmark"></span>
                    </label>
                </div>
            </td>
            <td class="service-name">
                <div class="group-name-container">
                    <span class="group-toggle">‚ñ∂</span>
                    <span class="group-name">${groupName} (${groupApps.length})</span>
                </div>
            </td>
            <td>${versionText}</td>
            <td>${statusDot} ${hasOffline ? 'Offline' : 'Online'}</td>
            <td>${serverName}</td>
            <td>
                <div class="actions-menu">
                    <button class="actions-button">...</button>
                    <div class="actions-dropdown">
                        ${createGroupActionMenu(groupName, groupApps)}
                    </div>
                </div>
            </td>
        `;
        
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.checkbox-container') && !e.target.closest('.actions-menu')) {
                toggleGroupExpansion(groupName);
            }
        });
        
        return row;
    }

    function createApplicationRow(app, isChild) {
        const row = document.createElement('tr');
        row.className = isChild ? 'app-row child-row' : 'app-row';
        row.setAttribute('data-app-id', app.id);
        row.setAttribute('data-app-name', app.name.toLowerCase());
        
        const statusDot = app.status === 'online' ? 
            '<span class="service-dot"></span>' : 
            '<span class="service-dot offline"></span>';
        
        row.innerHTML = `
            <td>
                <div class="checkbox-container">
                    <label class="custom-checkbox">
                        <input type="checkbox" class="app-checkbox" data-app-id="${app.id}">
                        <span class="checkmark"></span>
                    </label>
                </div>
            </td>
            <td class="service-name ${isChild ? 'child-indent' : ''}">
                ${app.name}
                <div class="dist-details">
                    <div>–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: ${app.start_time ? new Date(app.start_time).toLocaleString() : '–ù/–î'}</div>
                    <div>–ü—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${app.path || '–ù/–î'}</div>
                    <div>–ü—É—Ç—å –∫ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—É: ${app.distr_path || '–ù/–î'}</div>
                </div>
            </td>
            <td>${app.version || '–ù/–î'}</td>
            <td>${statusDot} ${app.status}</td>
            <td>${app.server_name || '–ù/–î'}</td>
            <td>
                <div class="actions-menu">
                    <button class="actions-button">...</button>
                    <div class="actions-dropdown">
                        ${createActionMenuItems(app)}
                    </div>
                </div>
            </td>
        `;
        
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.checkbox-container') && !e.target.closest('.actions-menu')) {
                this.classList.toggle('expanded');
            }
        });
        
        return row;
    }

    function createActionMenuItems(app) {
        return `
            <a href="#" class="app-info-btn" data-app-id="${app.id}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a>
            <a href="#" class="app-start-btn ${!isActionAvailable(app, 'start') ? 'disabled' : ''}" 
               data-app-id="${app.id}" data-action="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å</a>
            <a href="#" class="app-stop-btn ${!isActionAvailable(app, 'stop') ? 'disabled' : ''}" 
               data-app-id="${app.id}" data-action="stop">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</a>
            <a href="#" class="app-restart-btn ${!isActionAvailable(app, 'restart') ? 'disabled' : ''}" 
               data-app-id="${app.id}" data-action="restart">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</a>
            <a href="#" class="app-update-btn" data-app-id="${app.id}">–û–±–Ω–æ–≤–∏—Ç—å</a>
        `;
    }

    function createGroupActionMenu(group, apps) {
        return `
            <a href="#" class="group-info-btn" data-group="${group}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a>
            <a href="#" class="group-start-btn ${!isGroupActionAvailable(apps, 'start') ? 'disabled' : ''}" 
               data-group="${group}" data-action="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ</a>
            <a href="#" class="group-stop-btn ${!isGroupActionAvailable(apps, 'stop') ? 'disabled' : ''}" 
               data-group="${group}" data-action="stop">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ</a>
            <a href="#" class="group-restart-btn ${!isGroupActionAvailable(apps, 'restart') ? 'disabled' : ''}" 
               data-group="${group}" data-action="restart">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ</a>
            <a href="#" class="group-update-btn" 
               data-group="${group}" data-action="update">–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ</a>
        `;
    }

    function isActionAvailable(app, action) {
        const status = (app.status || '').toLowerCase();
        
        switch(action) {
            case 'start':
                return status !== 'online';
            case 'stop':
            case 'restart':
                return status === 'online';
            case 'update':
                return true;
            default:
                return true;
        }
    }

    function isGroupActionAvailable(apps, action) {
        if (!apps || apps.length === 0) {
            return false;
        }
        
        switch(action) {
            case 'start':
                return apps.some(app => (app.status || '').toLowerCase() !== 'online');
            case 'stop':
            case 'restart':
                return apps.some(app => (app.status || '').toLowerCase() === 'online');
            case 'update':
                return true;
            default:
                return true;
        }
    }

    function toggleGroupExpansion(groupName) {
        const groupRow = document.querySelector(`.group-row[data-group="${groupName}"]`);
        const wrapperRow = document.querySelector(`.child-wrapper[data-group="${groupName}"]`);
        
        if (groupRow && wrapperRow) {
            const isExpanded = wrapperRow.classList.contains('expanded');
            const toggleIcon = groupRow.querySelector('.group-toggle');
            
            if (isExpanded) {
                wrapperRow.classList.remove('expanded');
                toggleIcon.textContent = '‚ñ∂';
            } else {
                wrapperRow.classList.add('expanded');
                toggleIcon.textContent = '‚ñº';
            }
        }
    }

    // ========================================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô –¢–ê–ë–õ–ò–¶–´
    // ========================================
    function setupTableEventHandlers() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ–∫–±–æ–∫—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
        document.querySelectorAll('.app-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                const appId = this.getAttribute('data-app-id');
                if (this.checked) {
                    selectedItemsState.applications.add(appId);
                } else {
                    selectedItemsState.applications.delete(appId);
                }
                updateSelectAllState();
                updateActionButtonsState();
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ–∫–±–æ–∫—Å–æ–≤ –≥—Ä—É–ø–ø
        document.querySelectorAll('.group-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                const groupName = this.getAttribute('data-group');
                const isChecked = this.checked;
                
                if (isChecked) {
                    selectedItemsState.groups.add(groupName);
                } else {
                    selectedItemsState.groups.delete(groupName);
                }
                
                const childCheckboxes = document.querySelectorAll(`.app-child-row[data-parent="${groupName}"] .app-checkbox`);
                childCheckboxes.forEach(childBox => {
                    childBox.checked = isChecked;
                    const appId = childBox.getAttribute('data-app-id');
                    if (isChecked) {
                        selectedItemsState.applications.add(appId);
                    } else {
                        selectedItemsState.applications.delete(appId);
                    }
                });
                
                updateSelectAllState();
                updateActionButtonsState();
            });
        });
        
        setupAppActionButtons();
        setupGroupActionButtons();
    }

    function setupAppActionButtons() {
        document.querySelectorAll('.app-info-btn, .app-start-btn, .app-stop-btn, .app-restart-btn, .app-update-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (this.classList.contains('disabled')) {
                    return;
                }
                
                const appId = this.getAttribute('data-app-id');
                const action = this.getAttribute('data-action') || 
                    (this.className.includes('info') ? 'info' :
                    this.className.includes('start') ? 'start' :
                    this.className.includes('stop') ? 'stop' :
                    this.className.includes('restart') ? 'restart' :
                    this.className.includes('update') ? 'update' : null);
                
                const app = getAppById(appId);
                if (!app) {
                    console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å ID: ${appId}`);
                    return;
                }
                
                if (action !== 'info' && action !== 'update' && !isActionAvailable(app, action)) {
                    const statusMsg = app.status === 'online' ? '—É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ' : '–Ω–µ –∑–∞–ø—É—â–µ–Ω–æ';
                    showError(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ "${action}" –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ ${statusMsg}`);
                    return;
                }
                
                switch(action) {
                    case 'info':
                        showAppInfoModal(appId);
                        break;
                    case 'start':
                    case 'stop':
                    case 'restart':
                        showConfirmActionModal([appId], action);
                        break;
                    case 'update':
                        showUpdateModal([appId]);
                        break;
                }
            });
        });
    }

    function setupGroupActionButtons() {
        document.querySelectorAll('.group-info-btn, .group-start-btn, .group-stop-btn, .group-restart-btn, .group-update-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (this.classList.contains('disabled')) {
                    return;
                }
                
                const groupName = this.getAttribute('data-group');
                const action = this.getAttribute('data-action') || 
                    (this.className.includes('info') ? 'info' :
                    this.className.includes('start') ? 'start' :
                    this.className.includes('stop') ? 'stop' :
                    this.className.includes('restart') ? 'restart' :
                    this.className.includes('update') ? 'update' : null);
                
                const groupApps = filteredApplications.filter(app => 
                    (app.group_name || app.name) === groupName
                );
                
                if (!groupApps || groupApps.length === 0) {
                    console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã: ${groupName}`);
                    return;
                }
                
                const appIds = groupApps.map(app => app.id);
                
                switch(action) {
                    case 'info':
                        showGroupInfoModal(groupName, groupApps);
                        break;
                    case 'start':
                    case 'stop':
                    case 'restart':
                        const filteredAppIds = appIds.filter(appId => {
                            const app = getAppById(appId);
                            return app && isActionAvailable(app, action);
                        });
                        
                        if (filteredAppIds.length === 0) {
                            showError(`–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–µ, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ "${action}"`);
                            return;
                        }
                        
                        const extraMessage = filteredAppIds.length < appIds.length ? 
                            `–ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –ø–æ–¥—Ö–æ–¥—è—â–∏–º —Å—Ç–∞—Ç—É—Å–æ–º (${filteredAppIds.length} –∏–∑ ${appIds.length})` : null;
                        
                        showConfirmActionModal(filteredAppIds, action, extraMessage);
                        break;
                    case 'update':
                        showUpdateModal(appIds);
                        break;
                }
            });
        });
    }

    // ========================================
    // –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
    // ========================================
    function showUpdateModal(appIds) {
        if (!appIds || appIds.length === 0) {
            showError('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            return;
        }
        
        let title = '';
        if (appIds.length === 1) {
            const app = getAppById(appIds[0]);
            title = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${app ? app.name : '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'}`;
        } else {
            title = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${appIds.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`;
        }
        
        if (appIds.length === 1) {
            showSimpleUpdateModal(appIds[0], title);
            return;
        }
        
        const appGroups = {};
        appIds.forEach(appId => {
            const app = getAppById(appId);
            if (app) {
                const groupName = app.group_name || app.name;
                if (!appGroups[groupName]) {
                    appGroups[groupName] = [];
                }
                appGroups[groupName].push(app);
            }
        });
        
        if (Object.keys(appGroups).length === 1) {
            const groupName = Object.keys(appGroups)[0];
            const groupApps = appGroups[groupName];
            const groupAppIds = groupApps.map(app => app.id);
            
            showSimpleUpdateModal(groupAppIds, `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã: ${groupName}`);
            return;
        }
        
        showTabsUpdateModal(appGroups, title);
    }

    async function showSimpleUpdateModal(appIds, title) {
        const appIdsArray = Array.isArray(appIds) ? appIds : [appIds];
        const apps = appIdsArray.map(id => getAppById(id)).filter(Boolean);
        
        if (apps.length === 0) {
            showError('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            return;
        }

        const firstApp = apps[0];
        const defaultDistrPath = firstApp.distr_path || '';
        
        const formFields = [];
        
        const versionData = await loadArtifactsWithCache(firstApp.id);
        const hasArtifacts = versionData && versionData.length > 0;
        
        if (hasArtifacts) {
            formFields.push({
                id: 'version-loader-container',
                type: 'custom',
                html: `
                    <div class="form-group animated-fade-in" style="animation-delay: 0.1s">
                        <div class="artifact-selector-wrapper">
                            <div class="artifact-selector-header">
                                <label for="distr-url">
                                    –í–µ—Ä—Å–∏—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞:
                                    <span class="version-count">(${versionData.length} –≤–µ—Ä—Å–∏–π)</span>
                                </label>
                                <button type="button" class="refresh-artifacts-btn" data-app-id="${firstApp.id}" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π">
                                    <span class="refresh-icon">‚ü≥</span>
                                </button>
                            </div>
                            <select id="distr-url" name="distr_url" class="form-control artifact-select" required>
                                ${createVersionSelect(versionData, defaultDistrPath)}
                            </select>
                        </div>
                    </div>
                `
            });
        } else {
            formFields.push({
                id: 'distr-url',
                name: 'distr_url',
                label: 'URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞:',
                type: 'text',
                value: defaultDistrPath,
                required: true
            });
        }
        
        formFields.push({
            id: 'restart-mode',
            name: 'restart_mode',
            label: '–†–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:',
            type: 'radio',
            value: 'restart',
            options: [
                { value: 'restart', text: '–í —Ä–µ—Å—Ç–∞—Ä—Ç' },
                { value: 'night-restart', text: '–ù–æ—á–Ω–æ–π —Ä–µ—Å—Ç–∞—Ä—Ç' }
            ]
        });
        
        formFields.push({
            id: 'app-ids',
            name: 'app_ids',
            type: 'hidden',
            value: appIdsArray.join(',')
        });
        
        const submitAction = function(formData) {
            if (formData.distr_url === 'custom' && formData.custom_distr_url) {
                formData.distr_url = formData.custom_distr_url;
            }
            delete formData.custom_distr_url;
            processUpdateForm(formData);
        };
        
        ModalUtils.showFormModal(title, formFields, submitAction, '–û–±–Ω–æ–≤–∏—Ç—å');
        
        setTimeout(() => {
            setupVersionSelectorHandlers(firstApp.id);
        }, 100);
    }

    function showTabsUpdateModal(appGroups, title) {
        const modalContent = document.createElement('div');
        
        const tabsContainer = document.createElement('div');
        tabsContainer.className = 'modal-tabs';
        modalContent.appendChild(tabsContainer);
        
        const form = document.createElement('form');
        form.id = 'update-form';
        form.className = 'modal-form';
        modalContent.appendChild(form);
        
        const groupStates = {};
        const groupArtifacts = {};
        const groupContentCache = {};
        const groupContentLoaded = {};
        
        Object.keys(appGroups).forEach((groupName, index) => {
            const tab = document.createElement('div');
            tab.className = `modal-tab ${index === 0 ? 'active' : ''}`;
            tab.innerHTML = `${groupName} <span class="app-count">(${appGroups[groupName].length})</span>`;
            tab.setAttribute('data-group', groupName);
            tabsContainer.appendChild(tab);
            
            const apps = appGroups[groupName];
            const firstApp = apps[0];
            
            groupStates[groupName] = {
                appIds: apps.map(app => app.id),
                distrUrl: firstApp && firstApp.distr_path ? firstApp.distr_path : '',
                restartMode: 'restart',
                artifactsLoaded: false
            };
            
            groupContentLoaded[groupName] = false;
        });
        
        const dynamicContent = document.createElement('div');
        dynamicContent.id = 'dynamic-group-content';
        form.appendChild(dynamicContent);
        
        async function updateFormContent(groupName, forceReload = false) {
            console.log(`üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è –≥—Ä—É–ø–ø—ã "${groupName}" (force=${forceReload})`);
            
            const state = groupStates[groupName];
            const apps = appGroups[groupName];
            
            if (!forceReload && groupContentLoaded[groupName] && groupContentCache[groupName]) {
                console.log(`‚ú® –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –≥—Ä—É–ø–ø—ã "${groupName}"`);
                dynamicContent.innerHTML = groupContentCache[groupName];
                
                setTimeout(() => {
                    attachFormHandlers(groupName);
                    restoreGroupState(groupName);
                }, 0);
                
                return;
            }
            
            dynamicContent.innerHTML = `
                <div class="group-content-loader">
                    <div class="loader-icon">
                        <div class="loader-rings">
                            <div class="ring ring-1"></div>
                            <div class="ring ring-2"></div>
                            <div class="ring ring-3"></div>
                        </div>
                    </div>
                    <div class="loader-text">
                        <span class="loading-label">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥—Ä—É–ø–ø—ã</span>
                        <span class="loading-dots"></span>
                    </div>
                    <div class="loader-details">${groupName}</div>
                </div>
            `;
            
            const startTime = Date.now();
            
            let artifacts = null;
            let loadingError = false;
            
            if (apps.length > 0 && (!groupArtifacts[groupName] || !state.artifactsLoaded)) {
                const firstApp = apps[0];
                
                setTimeout(() => {
                    const loaderText = document.querySelector('.loading-label');
                    if (loaderText) {
                        loaderText.textContent = apps.length > 1 ? 
                            `–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –¥–ª—è ${apps.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π` : 
                            '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π';
                    }
                }, 300);
                
                console.log(`üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø—ã "${groupName}"`);
                artifacts = await loadArtifactsWithCache(firstApp.id);
                
                if (artifacts) {
                    groupArtifacts[groupName] = artifacts;
                    state.artifactsLoaded = true;
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${artifacts.length} –≤–µ—Ä—Å–∏–π –¥–ª—è –≥—Ä—É–ø–ø—ã "${groupName}"`);
                } else {
                    loadingError = true;
                    console.error(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Ä—Å–∏–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã "${groupName}"`);
                }
            } else if (groupArtifacts[groupName]) {
                artifacts = groupArtifacts[groupName];
                console.log(`üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø—ã "${groupName}"`);
            }
            
            if (!groupContentLoaded[groupName]) {
                const elapsedTime = Date.now() - startTime;
                if (elapsedTime < 600) {
                    await new Promise(resolve => setTimeout(resolve, 600 - elapsedTime));
                }
            }
            
            let formHTML = '<div class="form-content-animated">';
            formHTML += `<input type="hidden" id="app-ids" name="app_ids" value="${state.appIds.join(',')}">`;
            
            if (artifacts && artifacts.length > 0) {
                formHTML += `
                    <div class="form-group animated-fade-in" style="animation-delay: 0.1s">
                        <div class="artifact-selector-wrapper">
                            <div class="artifact-selector-header">
                                <label for="distr-url">
                                    –í–µ—Ä—Å–∏—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞:
                                    <span class="version-count">(${artifacts.length} –≤–µ—Ä—Å–∏–π)</span>
                                </label>
                                <button type="button" class="refresh-artifacts-btn" data-group="${groupName}" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π">
                                    <span class="refresh-icon">‚ü≥</span>
                                </button>
                            </div>
                            <select id="distr-url" name="distr_url" class="form-control artifact-select" required>
                                ${createVersionSelect(artifacts, state.distrUrl)}
                            </select>
                            ${state.artifactsLoaded && typeof getArtifactsCacheAge === 'function' && apps[0] ? `
                                <div class="cache-status">
                                    ${getArtifactsCacheAge(apps[0].id) < 60 ? 
                                        '<span class="cache-fresh">‚úì –ö—ç—à –∞–∫—Ç—É–∞–ª–µ–Ω</span>' : 
                                        '<span class="cache-stale">‚ö† –ö—ç—à –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º</span>'}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div id="custom-url-group" class="form-group animated-fade-in" style="display: none; animation-delay: 0.2s">
                        <label for="custom-distr-url">URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞:</label>
                        <input type="text" id="custom-distr-url" class="form-control" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞" />
                    </div>
                `;
            } else if (loadingError) {
                formHTML += `
                    <div class="form-group animated-fade-in error-group" style="animation-delay: 0.1s">
                        <div class="error-message">
                            <span class="error-icon">‚ö†</span>
                            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π
                        </div>
                        <label for="distr-url">URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞:</label>
                        <input type="text" id="distr-url" name="distr_url" class="form-control" 
                            value="${state.distrUrl}" required />
                        <button type="button" class="load-artifacts-btn" 
                            data-group="${groupName}" data-app-id="${apps[0]?.id}">
                            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Ä—Å–∏–∏
                        </button>
                    </div>
                `;
            } else {
                formHTML += `
                    <div class="form-group animated-fade-in" style="animation-delay: 0.1s">
                        <label for="distr-url">URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞:</label>
                        <input type="text" id="distr-url" name="distr_url" class="form-control" 
                            value="${state.distrUrl}" required />
                    </div>
                `;
            }
            
            formHTML += `
                <div class="form-group animated-fade-in" style="animation-delay: 0.3s">
                    <label>–†–µ–∂–∏–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="restart_mode" value="restart" 
                                ${state.restartMode === 'restart' ? 'checked' : ''}>
                            <span>–û–±—ã—á–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="restart_mode" value="night-restart" 
                                ${state.restartMode === 'night-restart' ? 'checked' : ''}>
                            <span>–ù–æ—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫</span>
                        </label>
                    </div>
                </div>
            `;
            
            if (apps.length > 0) {
                formHTML += `
                    <div class="form-group app-list-group animated-fade-in" style="animation-delay: 0.4s">
                        <label>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ (${apps.length}):</label>
                        <div class="app-list-preview">
                            ${apps.map(app => `
                                <div class="app-item">
                                    <span class="app-name">${app.name}</span>
                                    <span class="app-server">${app.server_name || '–ù/–î'}</span>
                                    ${app.status === 'online' ? '<span class="status-indicator online">‚óè</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            formHTML += '</div>';
            
            groupContentCache[groupName] = formHTML;
            groupContentLoaded[groupName] = true;
            
            dynamicContent.style.opacity = '0';
            setTimeout(() => {
                dynamicContent.innerHTML = formHTML;
                dynamicContent.style.opacity = '1';
                
                attachFormHandlers(groupName);
                restoreGroupState(groupName);
            }, 200);
        }
        
        function attachFormHandlers(groupName) {
            const selectElement = document.getElementById('distr-url');
            const customUrlGroup = document.getElementById('custom-url-group');
            
            if (selectElement && selectElement.tagName === 'SELECT' && customUrlGroup) {
                selectElement.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customUrlGroup.style.display = 'block';
                        const customInput = document.getElementById('custom-distr-url');
                        if (customInput) {
                            customInput.required = true;
                            setTimeout(() => customInput.focus(), 100);
                        }
                    } else {
                        customUrlGroup.style.display = 'none';
                        const customInput = document.getElementById('custom-distr-url');
                        if (customInput) {
                            customInput.required = false;
                        }
                    }
                    saveCurrentGroupState();
                });
            }
            
            const refreshBtn = document.querySelector('.refresh-artifacts-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async function() {
                    this.classList.add('rotating');
                    this.disabled = true;
                    
                    const group = this.getAttribute('data-group');
                    const apps = appGroups[group];
                    
                    if (apps && apps.length > 0) {
                        clearArtifactsCache(apps[0].id);
                        
                        const artifacts = await loadArtifactsWithCache(apps[0].id);
                        if (artifacts) {
                            groupArtifacts[group] = artifacts;
                            groupStates[group].artifactsLoaded = true;
                            
                            delete groupContentCache[group];
                            groupContentLoaded[group] = false;
                            
                            await updateFormContent(group, true);
                            showNotification('–°–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω');
                        } else {
                            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π');
                        }
                    }
                    
                    this.classList.remove('rotating');
                    this.disabled = false;
                });
            }
            
            const restartModeRadios = document.querySelectorAll('input[name="restart_mode"]');
            restartModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    saveCurrentGroupState();
                });
            });
            
            const loadBtn = document.querySelector('.load-artifacts-btn');
            if (loadBtn) {
                loadBtn.addEventListener('click', async function() {
                    this.classList.add('rotating');
                    this.disabled = true;
                    
                    const group = this.getAttribute('data-group');
                    const appId = this.getAttribute('data-app-id');
                    
                    const artifacts = await loadArtifactsWithCache(appId);
                    if (artifacts) {
                        groupArtifacts[group] = artifacts;
                        groupStates[group].artifactsLoaded = true;
                        
                        delete groupContentCache[group];
                        groupContentLoaded[group] = false;
                        
                        saveCurrentGroupState();
                        await updateFormContent(group, true);
                        
                        showNotification('–°–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω');
                    } else {
                        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π');
                    }
                    
                    this.classList.remove('rotating');
                    this.disabled = false;
                });
            }
        }
        
        function saveCurrentGroupState() {
            const currentGroup = tabsContainer.querySelector('.modal-tab.active');
            if (!currentGroup) return;
            
            const groupName = currentGroup.getAttribute('data-group');
            const distrUrlElement = document.getElementById('distr-url');
            const restartModeElement = document.querySelector('input[name="restart_mode"]:checked');
            
            if (distrUrlElement) {
                let distrUrl = distrUrlElement.value;
                
                if (distrUrl === 'custom') {
                    const customUrlElement = document.getElementById('custom-distr-url');
                    if (customUrlElement && customUrlElement.value) {
                        distrUrl = customUrlElement.value;
                    }
                }
                
                groupStates[groupName].distrUrl = distrUrl;
            }
            
            if (restartModeElement) {
                groupStates[groupName].restartMode = restartModeElement.value;
            }
        }
        
        function restoreGroupState(groupName) {
            const state = groupStates[groupName];
            if (!state) return;
            
            const distrUrlElement = document.getElementById('distr-url');
            if (distrUrlElement) {
                if (distrUrlElement.tagName === 'SELECT') {
                    if (distrUrlElement.querySelector(`option[value="${state.distrUrl}"]`)) {
                        distrUrlElement.value = state.distrUrl;
                    }
                } else {
                    distrUrlElement.value = state.distrUrl;
                }
            }
            
            const restartModeElement = document.querySelector(`input[name="restart_mode"][value="${state.restartMode}"]`);
            if (restartModeElement) {
                restartModeElement.checked = true;
            }
        }
        
        tabsContainer.addEventListener('click', async function(e) {
            const tab = e.target.closest('.modal-tab');
            if (!tab) return;
            
            if (tab.classList.contains('active')) {
                console.log('–í–∫–ª–∞–¥–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                return;
            }
            
            saveCurrentGroupState();
            
            tabsContainer.querySelectorAll('.modal-tab').forEach(t => {
                t.classList.remove('active');
            });
            tab.classList.add('active');
            
            const groupName = tab.getAttribute('data-group');
            await updateFormContent(groupName);
        });
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (this.dataset.processing === 'true') {
                console.log('–§–æ—Ä–º–∞ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è');
                return;
            }
            
            this.dataset.processing = 'true';
            
            try {
                saveCurrentGroupState();
                
                const allUpdates = [];
                
                for (const groupName of Object.keys(groupStates)) {
                    const state = groupStates[groupName];
                    
                    if (!state.distrUrl || state.distrUrl.trim() === '') {
                        continue;
                    }
                    
                    for (const appId of state.appIds) {
                        const app = getAppById(appId);
                        if (!app) continue;
                        
                        allUpdates.push({
                            appId: appId,
                            appName: app.name,
                            groupName: groupName,
                            distr_url: state.distrUrl,
                            restart_mode: state.restartMode || 'restart'
                        });
                    }
                }
                
                if (allUpdates.length === 0) {
                    showError('–£–∫–∞–∂–∏—Ç–µ URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã');
                    return;
                }
                
                console.log(`üöÄ –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${allUpdates.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
                await processMultipleUpdates(allUpdates);
                
            } finally {
                this.dataset.processing = 'false';
            }
        });
        
        const formActions = document.createElement('div');
        formActions.className = 'form-actions';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'cancel-btn';
        cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
        cancelBtn.onclick = function() {
            Object.keys(groupContentCache).forEach(key => delete groupContentCache[key]);
            Object.keys(groupContentLoaded).forEach(key => delete groupContentLoaded[key]);
            window.closeModal();
        };
        formActions.appendChild(cancelBtn);
        
        const submitBtn = document.createElement('button');
        submitBtn.type = 'submit';
        submitBtn.className = 'submit-btn';
        submitBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
        formActions.appendChild(submitBtn);
        
        form.appendChild(formActions);
        
        window.showModal(title, modalContent);
        
        const firstGroup = Object.keys(appGroups)[0];
        updateFormContent(firstGroup);
    }

    function createVersionSelect(artifacts, currentValue) {
        let options = artifacts.map(version => {
            let label = version.version;
            let className = '';
            
            const versionLower = version.version.toLowerCase();
            if (versionLower.includes('snapshot')) {
                label += ' üîß';
                className = 'version-snapshot';
            } else if (versionLower.includes('dev')) {
                label += ' üîπ';
                className = 'version-dev';
            } else if (version.is_release) {
                label += ' ‚úÖ';
                className = 'version-release';
            }
            
            return `<option value="${version.url}" class="${className}">${label}</option>`;
        }).join('');
        
        return options + '<option value="custom" class="custom-option">‚ûï –£–∫–∞–∑–∞—Ç—å –≤—Ä—É—á–Ω—É—é...</option>';
    }

    function setupVersionSelectorHandlers(appId) {
        const select = document.getElementById('distr-url');
        if (select && select.tagName === 'SELECT') {
            select.addEventListener('change', function(e) {
                if (e.target.value === 'custom') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = 'distr-url';
                    input.name = 'distr_url';
                    input.className = 'form-control';
                    input.required = true;
                    input.placeholder = '–í–≤–µ–¥–∏—Ç–µ URL –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞';
                    
                    e.target.parentNode.replaceChild(input, e.target);
                    input.focus();
                }
            });
        }
        
        const refreshBtn = document.querySelector('.refresh-artifacts-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async function() {
                this.classList.add('rotating');
                this.disabled = true;
                
                clearArtifactsCache(appId);
                const artifacts = await loadArtifactsWithCache(appId);
                
                if (artifacts) {
                    const selectContainer = document.getElementById('version-loader-container');
                    if (selectContainer) {
                        const currentValue = document.getElementById('distr-url')?.value;
                        
                        selectContainer.innerHTML = `
                            <div class="form-group animated-fade-in">
                                <div class="artifact-selector-wrapper">
                                    <div class="artifact-selector-header">
                                        <label for="distr-url">
                                            –í–µ—Ä—Å–∏—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞:
                                            <span class="version-count">(${artifacts.length} –≤–µ—Ä—Å–∏–π)</span>
                                        </label>
                                        <button type="button" class="refresh-artifacts-btn" data-app-id="${appId}" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π">
                                            <span class="refresh-icon">‚ü≥</span>
                                        </button>
                                    </div>
                                    <select id="distr-url" name="distr_url" class="form-control artifact-select" required>
                                        ${createVersionSelect(artifacts, currentValue)}
                                    </select>
                                </div>
                            </div>
                        `;
                        
                        setupVersionSelectorHandlers(appId);
                    }
                    
                    showNotification('–°–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω');
                } else {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π');
                }
                
                this.classList.remove('rotating');
                this.disabled = false;
            });
        }
    }

    async function processUpdateForm(formData) {
        const appIds = formData.app_ids ? 
            (Array.isArray(formData.app_ids) ? formData.app_ids : formData.app_ids.split(',')) : [];
        
        if (appIds.length === 0) {
            showError('–ù–µ —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            return;
        }
        
        const updates = appIds.map(appId => {
            const app = getAppById(appId);
            if (!app) return null;
            
            return {
                appId: appId,
                appName: app.name,
                distr_url: formData.distr_url,
                restart_mode: formData.restart_mode || 'restart'
            };
        }).filter(Boolean);
        
        await processMultipleUpdates(updates);
    }

    async function processMultipleUpdates(updates) {
        if (!updates || updates.length === 0) {
            showError('–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            return;
        }
        
        showNotification(`–ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${updates.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π...`);
        
        const results = [];
        const errors = [];
        
        for (const update of updates) {
            try {
                console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${update.appName} (ID: ${update.appId})`);
                
                const app = getAppById(update.appId);
                const updateParams = {
                    restart_mode: update.restart_mode
                };
                
                if (app && app.app_type === 'docker') {
                    updateParams.image_name = update.distr_url;
                    updateParams.distr_url = update.distr_url;
                } else {
                    updateParams.distr_url = update.distr_url;
                }
                
                const response = await fetch(`/api/applications/${update.appId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateParams)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    results.push({
                        appId: update.appId,
                        appName: update.appName,
                        groupName: update.groupName,
                        success: true,
                        message: data.message
                    });
                } else {
                    errors.push({
                        appId: update.appId,
                        appName: update.appName,
                        groupName: update.groupName,
                        success: false,
                        error: data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
                    });
                }
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${update.appName}:`, error);
                errors.push({
                    appId: update.appId,
                    appName: update.appName,
                    groupName: update.groupName,
                    success: false,
                    error: error.message
                });
            }
        }
        
        const successCount = results.length;
        const errorCount = errors.length;
        
        if (errorCount === 0) {
            showNotification(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö ${successCount} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
        } else if (successCount === 0) {
            showError(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è`);
        } else {
            showNotification(`‚ö†Ô∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –¥–ª—è ${successCount} –∏–∑ ${updates.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
        }
        
        if (errors.length > 0) {
            console.error('–û—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', errors);
            errors.forEach(err => {
                console.error(`‚ùå ${err.appName} (–≥—Ä—É–ø–ø–∞: ${err.groupName}): ${err.error}`);
            });
        }
        
        if (results.length > 0) {
            console.log('–£—Å–ø–µ—à–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', results);
            results.forEach(res => {
                console.log(`‚úÖ ${res.appName} (–≥—Ä—É–ø–ø–∞: ${res.groupName})`);
            });
        }
        
        await loadApplications();
        window.closeModal();
    }

    async function showAppInfoModal(appId) {
        try {
            const response = await fetch(`/api/applications/${appId}`);
            const data = await response.json();
            
            if (!data.success) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:', data.error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
                return;
            }
            
            const app = data.application;
            
            const sections = [
                {
                    title: '–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                    type: 'table',
                    rows: [
                        { label: '–ò–º—è:', value: app.name },
                        { label: '–¢–∏–ø:', value: app.app_type || '–ù–µ —É–∫–∞–∑–∞–Ω' },
                        { label: '–°—Ç–∞—Ç—É—Å:', value: `<span class="status-badge ${app.status === 'online' ? 'online' : 'offline'}">${app.status}</span>` },
                        { label: '–í–µ—Ä—Å–∏—è:', value: app.version || '–ù–µ —É–∫–∞–∑–∞–Ω–∞' },
                        { label: '–°–µ—Ä–≤–µ—Ä:', value: app.server_name || '–ù–µ —É–∫–∞–∑–∞–Ω' }
                    ]
                }
            ];
            
            if (app.app_type === 'docker') {
                sections.push({
                    title: 'Docker –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                    type: 'table',
                    rows: [
                        { label: '–û–±—Ä–∞–∑:', value: app.docker_image || '–ù–µ —É–∫–∞–∑–∞–Ω' },
                        { label: '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ID:', value: app.container_id || '–ù–µ —É–∫–∞–∑–∞–Ω' }
                    ]
                });
            }
            
            if (app.start_time || app.path || app.distr_path) {
                sections.push({
                    title: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                    type: 'table',
                    rows: [
                        { label: '–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:', value: app.start_time ? new Date(app.start_time).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–æ' },
                        { label: '–ü—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', value: app.path || '–ù–µ —É–∫–∞–∑–∞–Ω' },
                        { label: '–ü—É—Ç—å –∫ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—É:', value: app.distr_path || '–ù–µ —É–∫–∞–∑–∞–Ω' }
                    ]
                });
            }
            
            if (app.ansible_playbook_path) {
                sections.push({
                    title: 'Ansible Playbook',
                    type: 'html',
                    content: `<pre>${app.ansible_playbook_path}</pre>`
                });
            }
            
            const content = ModalUtils.createModalContent(sections);
            window.showModal('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', content);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
        }
    }

    function showGroupInfoModal(groupName, apps) {
        const onlineCount = apps.filter(app => app.status === 'online').length;
        const offlineCount = apps.length - onlineCount;
        
        const sections = [
            {
                title: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ',
                type: 'table',
                rows: [
                    { label: '–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:', value: groupName },
                    { label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:', value: apps.length },
                    { label: '–ê–∫—Ç–∏–≤–Ω—ã–µ:', value: `<span class="status-online">${onlineCount}</span>` },
                    { label: '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ:', value: `<span class="status-offline">${offlineCount}</span>` }
                ]
            },
            {
                title: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ',
                type: 'list',
                items: apps.map(app => {
                    const status = app.status === 'online' ? 
                        '<span class="status-dot online"></span>' : 
                        '<span class="status-dot offline"></span>';
                    return `${status} ${app.name} (${app.server_name || '–ù/–î'})`;
                })
            }
        ];
        
        const content = ModalUtils.createModalContent(sections);
        window.showModal(`–ì—Ä—É–ø–ø–∞: ${groupName}`, content);
    }

    function showConfirmActionModal(appIds, action, extraMessage) {
        if (!appIds || appIds.length === 0) {
            showError('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            return;
        }
        
        const actionNames = {
            'start': '–∑–∞–ø—É—Å—Ç–∏—Ç—å',
            'stop': '–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
            'restart': '–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å'
        };
        
        const actionName = actionNames[action] || action;
        
        const appItems = appIds.map(appId => {
            const app = getAppById(appId);
            return app ? `${app.name} (${app.server_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–µ—Ä–≤–µ—Ä'})` : `App ID: ${appId}`;
        });
        
        const confirmAction = async function() {
            try {
                saveTableState();
                
                const response = await fetch('/api/applications/bulk/manage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        app_ids: appIds
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const successCount = data.results.filter(r => r.success).length;
                    const errorCount = data.results.length - successCount;
                    
                    if (errorCount === 0) {
                        showNotification(`–î–µ–π—Å—Ç–≤–∏–µ "${actionName}" —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
                    } else if (successCount === 0) {
                        showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ "${actionName}" –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
                    } else {
                        showNotification(`–î–µ–π—Å—Ç–≤–∏–µ "${actionName}" –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è ${successCount} –∏–∑ ${data.results.length} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`);
                    }
                    
                    await loadApplications();
                    
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è:', data.error);
                    showError(data.error || `–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ "${actionName}"`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è:', error);
                showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ "${actionName}"`);
            }
        };
        
        let message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ <span class="action-name">${actionName}</span> –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?`;
        if (extraMessage) {
            message += `<br><small>${extraMessage}</small>`;
        }
        
        ModalUtils.showConfirmModal(
            `${actionName.charAt(0).toUpperCase() + actionName.slice(1)} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è`,
            message,
            appItems,
            confirmAction,
            `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (${appIds.length})`,
            'confirm-btn'
        );
    }

    // ========================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // ========================================
    function updatePagination(totalPages) {
        if (!paginationControls) return;
        
        paginationControls.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        if (currentPage > 1) {
            paginationControls.innerHTML += `<button onclick="changePage(${currentPage - 1})" class="pagination-btn">‚Äπ</button>`;
        }
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                const active = i === currentPage ? 'active' : '';
                paginationControls.innerHTML += `<button onclick="changePage(${i})" class="pagination-btn ${active}">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                paginationControls.innerHTML += `<span class="pagination-dots">...</span>`;
            }
        }
        
        if (currentPage < totalPages) {
            paginationControls.innerHTML += `<button onclick="changePage(${currentPage + 1})" class="pagination-btn">‚Ä∫</button>`;
        }
    }

    window.changePage = function(page) {
        currentPage = page;
        filterAndDisplayApplications();
    };

    function updateSelectAllState() {
        if (!selectAllCheckbox) return;
        
        const allCheckboxes = document.querySelectorAll('.app-checkbox, .group-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.app-checkbox:checked, .group-checkbox:checked');
        
        selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
    }

    function updateActionButtonsState() {
        const hasSelectedItems = selectedItemsState.applications.size > 0;

        if (startBtn) startBtn.disabled = !hasSelectedItems;
        if (restartBtn) restartBtn.disabled = !hasSelectedItems;
        if (stopBtn) stopBtn.disabled = !hasSelectedItems;
        if (updateBtn) updateBtn.disabled = !hasSelectedItems;
        if (unloadBtn) unloadBtn.disabled = !hasSelectedItems;
        
        [startBtn, restartBtn, stopBtn, updateBtn, unloadBtn].forEach(btn => {
            if (!btn) return;
            
            if (hasSelectedItems) {
                btn.classList.remove('disabled');
            } else {
                btn.classList.add('disabled');
            }
        });
    }

    function getSelectedAppIds() {
        return Array.from(selectedItemsState.applications);
    }

    function getAppById(appId) {
        return allApplications.find(app => app.id == appId);
    }

    function clearCheckboxState() {
        selectedItemsState.applications.clear();
        selectedItemsState.groups.clear();
    }

    function restoreCheckboxState() {
        selectedItemsState.applications.forEach(appId => {
            const checkbox = document.querySelector(`.app-checkbox[data-app-id="${appId}"]`);
            if (checkbox) checkbox.checked = true;
        });
        
        selectedItemsState.groups.forEach(groupName => {
            const checkbox = document.querySelector(`.group-checkbox[data-group="${groupName}"]`);
            if (checkbox) checkbox.checked = true;
        });
        
        updateSelectAllState();
        updateActionButtonsState();
    }

    function saveTableState() {
        expandedGroups = [];
        
        document.querySelectorAll('.child-wrapper.expanded').forEach(row => {
            const groupName = row.getAttribute('data-group');
            if (groupName) {
                expandedGroups.push(groupName);
            }
        });
        
        document.querySelectorAll('.app-row.expanded').forEach(row => {
            const appId = row.getAttribute('data-app-id');
            if (appId) {
                expandedGroups.push(`app_${appId}`);
            }
        });
    }

    function restoreTableState() {
        expandedGroups.forEach(item => {
            if (item.startsWith('app_')) {
                const appId = item.substring(4);
                const appRow = document.querySelector(`.app-row[data-app-id="${appId}"]`);
                if (appRow) {
                    appRow.classList.add('expanded');
                }
            } else {
                toggleGroupExpansion(item);
            }
        });
    }

    function clearArtifactsCache(appId = null) {
        if (appId) {
            delete artifactsCache[`app_${appId}`];
            console.log(`–ö—ç—à –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –æ—á–∏—â–µ–Ω –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${appId}`);
        } else {
            Object.keys(artifactsCache).forEach(key => {
                delete artifactsCache[key];
            });
            console.log('–í–µ—Å—å –∫—ç—à –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –æ—á–∏—â–µ–Ω');
        }
    }

    function getArtifactsCacheAge(appId) {
        const cacheKey = `app_${appId}`;
        if (artifactsCache[cacheKey]) {
            return (Date.now() - artifactsCache[cacheKey].timestamp) / 1000;
        }
        return Infinity;
    }

    function handleBulkAction(appIds, action) {
        const filteredAppIds = appIds.filter(appId => {
            const app = getAppById(appId);
            return app && isActionAvailable(app, action);
        });
        
        if (filteredAppIds.length === 0) {
            showError(`–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ "${action}"`);
            return;
        }
        
        const extraMessage = filteredAppIds.length < appIds.length ? 
            `–ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –ø–æ–¥—Ö–æ–¥—è—â–∏–º —Å—Ç–∞—Ç—É—Å–æ–º (${filteredAppIds.length} –∏–∑ ${appIds.length})` : null;
        
        showConfirmActionModal(filteredAppIds, action, extraMessage);
    }

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    window.clearArtifactsCache = clearArtifactsCache;
    window.debugArtifactsCache = function() {
        console.log('=== Artifacts Cache Debug ===');
        Object.keys(artifactsCache).forEach(key => {
            const cache = artifactsCache[key];
            const age = Math.round((Date.now() - cache.timestamp) / 1000);
            console.log(`${key}: ${cache.data.length} versions, age: ${age}s`);
        });
        console.log('===========================');
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    document.addEventListener('submit', async function(e) {
        if (e.target && e.target.id === 'update-form') {
            e.preventDefault();
            
            const hasTabs = e.target.closest('.modal-content')?.querySelector('.modal-tabs');
            if (hasTabs) {
                return;
            }

            const formData = new FormData(e.target);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            const distrSelect = document.getElementById('distr-url');
            const customInput = document.getElementById('custom-distr-url');
            
            if (distrSelect && distrSelect.value === 'custom' && customInput && customInput.value) {
                data.distr_url = customInput.value;
            }
            
            await processUpdateForm(data);
        }
    });
});
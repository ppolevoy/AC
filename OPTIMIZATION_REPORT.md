# –û—Ç—á–µ—Ç –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ë–î –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

**–î–∞—Ç–∞**: 2025-11-17
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 1. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü ‚úÖ

–£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:

- `application_instances_old_junction` - 45 –∑–∞–ø–∏—Å–µ–π
- `applications_backup` - 45 –∑–∞–ø–∏—Å–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞ –æ—Ç legacy —Å—Ç—Ä—É–∫—Ç—É—Ä, —É–º–µ–Ω—å—à–µ–Ω –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö.

---

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ‚úÖ

–°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

#### application_instances (8 –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤):
- `idx_app_instances_server_id` - –ø–æ–∏—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø–æ —Å–µ—Ä–≤–µ—Ä—É
- `idx_app_instances_group_id` - JOIN —Å –≥—Ä—É–ø–ø–∞–º–∏
- `idx_app_instances_catalog_id` - JOIN —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º
- `idx_app_instances_status` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
- `idx_app_instances_instance_name` - –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏
- `idx_app_instances_deleted_at` - —Ñ–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (partial index)
- `idx_app_instances_ip_port` - HAProxy –º–∞–ø–ø–∏–Ω–≥ –ø–æ IP:port (partial index)
- `idx_app_instances_server_group` - –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### application_groups (1 –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å):
- `idx_app_groups_catalog_id` - JOIN —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º

#### events (3 –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–∞):
- `idx_events_instance_id` - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `idx_events_timestamp` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (DESC)
- `idx_events_event_type` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏–π

**–í—Å–µ–≥–æ —Å–æ–∑–¥–∞–Ω–æ**: 12 –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
**–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î**: 54

---

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ ‚úÖ

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö:

- `app/api/app_groups_routes.py` - —Ä–∞–±–æ—Ç–∞ —Å –≥—Ä—É–ø–ø–∞–º–∏
- `app/services/haproxy_mapper.py` - –º–∞–ø–ø–∏–Ω–≥ HAProxy —Å–µ—Ä–≤–µ—Ä–æ–≤
- `app/services/agent_service.py` - —Ä–∞–±–æ—Ç–∞ —Å –∞–≥–µ–Ω—Ç–∞–º–∏
- `app/services/eureka_mapper.py` - –º–∞–ø–ø–∏–Ω–≥ Eureka

**–í—ã–≤–æ–¥—ã**:
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –≤–∞–∂–Ω—ã–µ JOIN –∏ —Ñ–∏–ª—å—Ç—Ä—ã
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞

---

### 4. VACUUM ANALYZE ‚úÖ

–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ PostgreSQL:

- `application_instances`
- `application_groups`
- `application_catalog`
- `events`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π |
|----------|------------------|-------------------|
| JOIN Instance + Group | **0.002—Å** | 10 –∑–∞–ø–∏—Å–µ–π |
| –§–∏–ª—å—Ç—Ä –ø–æ server_id | **0.001—Å** | - |
| –§–∏–ª—å—Ç—Ä –ø–æ group_id | **0.003—Å** | 3 –∑–∞–ø–∏—Å–∏ |
| –ü–æ–∏—Å–∫ –ø–æ IP:port | **0.001—Å** | - |
| –ü–æ–∏—Å–∫ –ø–æ instance_name | **0.001—Å** | 1 –∑–∞–ø–∏—Å—å |

### –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

- –í—Å–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤: **45**
- –° –≥—Ä—É–ø–ø–æ–π: **45 (100.0%)**
- –° –∫–∞—Ç–∞–ª–æ–≥–æ–º: **45 (100.0%)**

‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–≤—è–∑–∞–Ω—ã

### –†–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü

| –¢–∞–±–ª–∏—Ü–∞ | –†–∞–∑–º–µ—Ä |
|---------|--------|
| application_instances | 320 kB |
| events | 176 kB |
| application_groups | 128 kB |
| application_catalog | 112 kB |

---

## –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–∏

### `/site/app/FAppControl/project/migrations/cleanup_and_optimize.py`

–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
- `run_migration()` - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
- `rollback_migration()` - –æ—Ç–∫–∞—Ç (—Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å–æ–≤, —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è)

**–ó–∞–ø—É—Å–∫**:
```bash
docker exec fak-apps sh -c "cd /app && PYTHONPATH=/app python3 migrations/cleanup_and_optimize.py"
```

**–û—Ç–∫–∞—Ç**:
```bash
docker exec fak-apps sh -c "cd /app && PYTHONPATH=/app python3 migrations/cleanup_and_optimize.py rollback"
```

---

## –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

### `/site/app/FAppControl/project/test_optimization.py`

–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- –†–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü

**–ó–∞–ø—É—Å–∫**:
```bash
docker exec fak-apps sh -c "cd /app && PYTHONPATH=/app python3 test_optimization.py"
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ **–í—Å–µ —Ä–∞–±–æ—Ç—ã –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ**

### –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

1. **–û—á–∏—Å—Ç–∫–∞ –ë–î**: –£–¥–∞–ª–µ–Ω—ã 2 —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ç–∞–±–ª–∏—Ü—ã
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –î–æ–±–∞–≤–ª–µ–Ω–æ 12 –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. **–ó–∞–ø—Ä–æ—Å—ã**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 0.003—Å
4. **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å**: 100% —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–≤—è–∑–∞–Ω—ã
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
- üìä –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

**–ê–≤—Ç–æ—Ä**: Claude Code
**–î–∞—Ç–∞**: 2025-11-17

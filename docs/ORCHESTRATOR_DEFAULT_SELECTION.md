# Логика выбора оркестратора по умолчанию

> **Дата:** 2025-12-01
> **Статус:** Реализовано

## Цель

При открытии модального окна обновления в режиме "Сейчас" автоматически определять значение оркестратора по умолчанию на основе наличия маппингов приложений с HAProxy или Eureka.

---

## Условие выбора

Оркестратор выбирается по умолчанию **только если**:

1. **ВСЕ** экземпляры приложений имеют маппинг (5 из 5, не 4 из 5)
2. Маппинг **одного типа**: либо все HAProxy, либо все Eureka
3. **Нельзя смешивать**: 3 HAProxy + 2 Eureka → "Без оркестрации"

---

## Примеры

| Приложений | HAProxy | Eureka | Результат |
|------------|---------|--------|-----------|
| 5 | 5 | 0 | ✅ Первый оркестратор |
| 5 | 0 | 5 | ✅ Первый оркестратор |
| 5 | 3 | 2 | ❌ Без оркестрации |
| 5 | 4 | 0 | ❌ Без оркестрации |
| 5 | 0 | 0 | ❌ Без оркестрации |

---

## Схема работы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ОТКРЫТИЕ МОДАЛЬНОГО ОКНА ОБНОВЛЕНИЯ                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ПАРАЛЛЕЛЬНАЯ ЗАГРУЗКА                               │
│  ┌─────────────────────────────┐   ┌─────────────────────────────────────┐  │
│  │  ApiService.loadOrchestrators│   │  ApiService.checkMappings(appIds)  │  │
│  │  GET /api/orchestrators     │   │  POST /api/orchestrators/           │  │
│  │                             │   │       validate-mappings             │  │
│  └─────────────────────────────┘   └─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    BACKEND: validate-mappings                               │
│                                                                             │
│   SELECT service_type, COUNT(DISTINCT application_id)                       │
│   FROM application_mappings                                                 │
│   WHERE application_id IN (app_ids) AND is_active = true                    │
│   GROUP BY service_type                                                     │
│                                                                             │
│   Возвращает:                                                               │
│   {                                                                         │
│     total: 5,                                                               │
│     haproxy_mapped: 5,                                                      │
│     eureka_mapped: 0,                                                       │
│     can_orchestrate: true   // total === haproxy OR total === eureka       │
│   }                                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ОПРЕДЕЛЕНИЕ ЗНАЧЕНИЯ ПО УМОЛЧАНИЮ                        │
│                                                                             │
│   if (orchestrators.length > 0 && mappingInfo.canOrchestrate) {             │
│       defaultOrchestrator = orchestrators[0].file_path;                     │
│   } else {                                                                  │
│       defaultOrchestrator = 'none';                                         │
│   }                                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ГЕНЕРАЦИЯ SELECT                                    │
│                                                                             │
│   <select>                                                                  │
│     <option value="none" [selected если defaultOrchestrator='none']>        │
│       Без оркестрации                                                       │
│     </option>                                                               │
│     <option value="orchestrator-50-50.yml" [selected если совпадает]>       │
│       orchestrator-50-50                                                    │
│     </option>                                                               │
│     ...                                                                     │
│   </select>                                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Схема для режима с вкладками (несколько групп)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    showTabsUpdateModal(appGroups)                           │
│                                                                             │
│   appGroups = {                                                             │
│     "jurws": [app1, app2, app3],                                            │
│     "mobws": [app4, app5]                                                   │
│   }                                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              ПАРАЛЛЕЛЬНАЯ ПРОВЕРКА МАППИНГОВ ДЛЯ КАЖДОЙ ГРУППЫ              │
│                                                                             │
│   Promise.all([                                                             │
│     checkMappings([1, 2, 3]),  // jurws                                     │
│     checkMappings([4, 5])      // mobws                                     │
│   ])                                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    ▼                                   ▼
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│          Группа "jurws"           │   │          Группа "mobws"           │
│                                   │   │                                   │
│  total: 3                         │   │  total: 2                         │
│  haproxy_mapped: 3                │   │  haproxy_mapped: 0                │
│  can_orchestrate: true            │   │  can_orchestrate: false           │
│                                   │   │                                   │
│  → defaultOrchestrator:           │   │  → defaultOrchestrator:           │
│    orchestrator-50-50.yml         │   │    'none'                         │
└───────────────────────────────────┘   └───────────────────────────────────┘
                    │                                   │
                    ▼                                   ▼
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│  Вкладка "jurws":                 │   │  Вкладка "mobws":                 │
│  [orchestrator-50-50] ◄── selected│   │  [Без оркестрации] ◄── selected   │
│  [orchestrator-rolling]           │   │  [orchestrator-50-50]             │
│  [Без оркестрации]                │   │  [orchestrator-rolling]           │
└───────────────────────────────────┘   └───────────────────────────────────┘
```

---

## Изменённые файлы

| Файл | Изменение |
|------|-----------|
| `app/api/orchestrator_routes.py` | Новый endpoint `POST /api/orchestrators/validate-mappings` |
| `app/static/js/applications/core/api-service.js` | Метод `checkMappings(appIds)` |
| `app/static/js/applications/applications.js` | `showSimpleUpdateModal`: параллельная загрузка + логика выбора |
| `app/static/js/applications/applications.js` | `showTabsUpdateModal`: проверка маппингов для каждой группы |

---

## API Endpoint

### POST /api/orchestrators/validate-mappings

**Request:**
```json
{
  "application_ids": [1, 2, 3, 4, 5]
}
```

**Response:**
```json
{
  "total": 5,
  "haproxy_mapped": 5,
  "eureka_mapped": 0,
  "all_haproxy": true,
  "all_eureka": false,
  "can_orchestrate": true
}
```

**Логика `can_orchestrate`:**
```python
can_orchestrate = (haproxy_count == total) or (eureka_count == total)
```

---

## Оптимизации

1. **Backend**: один SQL запрос с `GROUP BY` + `COUNT(DISTINCT)` вместо N запросов
2. **Frontend**: параллельные запросы через `Promise.all`
3. **showTabsUpdateModal**: проверка всех групп параллельно, результаты кэшируются в `Map`

---

## Тестирование

### Сценарий 1: Все приложения с HAProxy
- Выбрать 5 приложений с HAProxy маппингами
- Ожидание: первый оркестратор выбран по умолчанию

### Сценарий 2: Приложения без маппингов
- Выбрать приложения без HAProxy/Eureka маппингов
- Ожидание: "Без оркестрации" выбрано по умолчанию

### Сценарий 3: Частичные маппинги
- Выбрать 5 приложений, где 3 с HAProxy и 2 без
- Ожидание: "Без оркестрации" выбрано по умолчанию

### Сценарий 4: Смешанные маппинги
- Выбрать 5 приложений: 3 с HAProxy, 2 с Eureka
- Ожидание: "Без оркестрации" выбрано по умолчанию

### Сценарий 5: Несколько групп
- Выбрать приложения из разных групп
- Ожидание: каждая вкладка имеет своё значение по умолчанию

# Система тегов Application Control

## Оглавление
1. [Обзор](#обзор)
2. [Архитектура](#архитектура)
3. [Модели данных](#модели-данных)
4. [Типы тегов](#типы-тегов)
5. [Системные теги](#системные-теги)
6. [API](#api)
7. [Фронтенд компоненты](#фронтенд-компоненты)
8. [Схемы взаимодействия](#схемы-взаимодействия)
9. [Конфигурация](#конфигурация)

---

## Обзор

Система тегов предоставляет возможность маркировки и категоризации приложений (ApplicationInstance) и групп приложений (ApplicationGroup). Поддерживаются два типа тегов:

- **Пользовательские теги** - создаются вручную для произвольной категоризации
- **Системные теги** - управляются автоматически на основе состояния приложений

### Ключевые возможности

- Many-to-many связи между тегами и сущностями
- Наследование тегов от группы к приложениям
- Автоматическое кэширование тегов (`tags_cache`) для быстрой фильтрации
- Полная история изменений через `TagHistory`
- Автоназначение системных тегов при событиях (маппинги, синхронизация)
- Возможность отключения автоназначения для конкретных приложений

---

## Архитектура

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              СИСТЕМА ТЕГОВ                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐     ┌─────────────────────┐     ┌─────────────────────┐   │
│  │   Frontend  │────▶│      API Layer      │────▶│   Service Layer     │   │
│  │             │     │  (tags_routes.py)   │     │ (SystemTagsService) │   │
│  └─────────────┘     └─────────────────────┘     └─────────────────────┘   │
│         │                      │                           │                │
│         │                      │                           │                │
│         ▼                      ▼                           ▼                │
│  ┌─────────────┐     ┌─────────────────────┐     ┌─────────────────────┐   │
│  │ TagsModal   │     │   Tag Model         │     │   Tag Definitions   │   │
│  │ TagsRenderer│     │   ApplicationXxxTag │     │   TriggerType       │   │
│  └─────────────┘     │   TagHistory        │     │   SystemTagDef      │   │
│                      └─────────────────────┘     └─────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Файловая структура

```
app/
├── models/
│   └── tag.py                    # Модели Tag, ApplicationInstanceTag,
│                                 # ApplicationGroupTag, TagHistory
├── api/
│   └── tags_routes.py            # REST API endpoints
├── services/
│   └── system_tags/
│       ├── __init__.py           # Экспорт модуля
│       ├── definitions.py        # Определения системных тегов
│       └── service.py            # SystemTagsService
└── static/js/applications/
    ├── modals/
    │   └── tags-modal.js         # Модальные окна управления тегами
    └── ui/
        └── tags-renderer.js      # Рендеринг тегов в UI
```

---

## Модели данных

### Схема базы данных

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           СХЕМА БАЗЫ ДАННЫХ                                   │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────┐         ┌──────────────────────────────┐
│         tags            │         │    application_instances      │
├─────────────────────────┤         ├──────────────────────────────┤
│ id (PK)                 │         │ id (PK)                       │
│ name (UNIQUE, INDEX)    │         │ name                          │
│ display_name            │         │ app_type                      │
│ description             │         │ tags_cache (VARCHAR 512)      │
│ icon                    │         │ ...                           │
│ tag_type                │         └──────────────────────────────┘
│ css_class               │                      │
│ border_color            │                      │
│ text_color              │                      │
│ is_system               │                      │
│ show_in_table           │                      │
│ created_at              │                      │
│ updated_at              │                      │
└─────────────────────────┘                      │
           │                                     │
           │                                     │
           ▼                                     ▼
┌───────────────────────────────────────────────────────────────┐
│                 application_instance_tags                      │
├───────────────────────────────────────────────────────────────┤
│ id (PK)                                                        │
│ application_id (FK) ─────────────────────────────────────────▶│
│ tag_id (FK) ◀────────────────────────────────────────────────│
│ assigned_at                                                    │
│ assigned_by                                                    │
│ auto_assign_disabled                                           │
├───────────────────────────────────────────────────────────────┤
│ UNIQUE(application_id, tag_id)                                 │
│ INDEX(application_id)                                          │
│ INDEX(tag_id)                                                  │
└───────────────────────────────────────────────────────────────┘

┌─────────────────────────┐
│   application_groups    │         ┌───────────────────────────────────────┐
├─────────────────────────┤         │         application_group_tags         │
│ id (PK)                 │         ├───────────────────────────────────────┤
│ name                    │◀───────│ group_id (FK)                          │
│ tags_cache (VARCHAR 512)│         │ tag_id (FK) ─────────────────────────▶│
│ ...                     │         │ assigned_at                            │
└─────────────────────────┘         │ assigned_by                            │
                                    ├───────────────────────────────────────┤
                                    │ UNIQUE(group_id, tag_id)               │
                                    └───────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       tag_history                            │
├─────────────────────────────────────────────────────────────┤
│ id (PK)                                                      │
│ entity_type ('instance' | 'group')                           │
│ entity_id                                                    │
│ tag_id (FK, SET NULL on delete)                              │
│ action ('assigned' | 'removed' | 'updated' |                 │
│         'auto_assign_disabled' | 'auto_assign_enabled')      │
│ changed_by                                                   │
│ changed_at                                                   │
│ details (JSON)                                               │
├─────────────────────────────────────────────────────────────┤
│ INDEX(entity_type, entity_id)                                │
│ INDEX(changed_at)                                            │
└─────────────────────────────────────────────────────────────┘
```

### Модель Tag

**Файл:** `app/models/tag.py:9-86`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer, PK | Первичный ключ |
| `name` | String(64), UNIQUE | Уникальное имя тега (lowercase, без пробелов) |
| `display_name` | String(64) | Отображаемое имя |
| `description` | Text | Описание тега |
| `icon` | String(20) | Иконка (по умолчанию '●') |
| `tag_type` | String(20) | Тип: status, env, version, system, custom |
| `css_class` | String(50) | CSS класс для стилизации |
| `border_color` | String(7) | Цвет границы (#RRGGBB) |
| `text_color` | String(7) | Цвет текста (#RRGGBB) |
| `is_system` | Boolean | Системный тег (защищён от удаления) |
| `show_in_table` | Boolean | Показывать в таблице приложений |
| `created_at` | DateTime | Дата создания |
| `updated_at` | DateTime | Дата обновления |

### Модель ApplicationInstanceTag

**Файл:** `app/models/tag.py:89-105`

Связующая таблица между `ApplicationInstance` и `Tag`.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer, PK | Первичный ключ |
| `application_id` | Integer, FK | Ссылка на приложение |
| `tag_id` | Integer, FK | Ссылка на тег |
| `assigned_at` | DateTime | Дата назначения |
| `assigned_by` | String(64) | Кто назначил (user, system, auto:mapping, auto:app_type) |
| `auto_assign_disabled` | Boolean | Флаг отключения автоназначения |

### Модель ApplicationGroupTag

**Файл:** `app/models/tag.py:108-122`

Связующая таблица между `ApplicationGroup` и `Tag`.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer, PK | Первичный ключ |
| `group_id` | Integer, FK | Ссылка на группу |
| `tag_id` | Integer, FK | Ссылка на тег |
| `assigned_at` | DateTime | Дата назначения |
| `assigned_by` | String(64) | Кто назначил |

### Модель TagHistory

**Файл:** `app/models/tag.py:125-141`

Аудит всех изменений тегов.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer, PK | Первичный ключ |
| `entity_type` | String(20) | Тип сущности: 'instance' или 'group' |
| `entity_id` | Integer | ID сущности |
| `tag_id` | Integer, FK | Ссылка на тег (SET NULL при удалении) |
| `action` | String(20) | Действие: assigned, removed, updated |
| `changed_by` | String(64) | Кто изменил |
| `changed_at` | DateTime | Дата изменения |
| `details` | JSON | Дополнительные данные |

---

## Типы тегов

### Пользовательские теги

Создаются вручную через API или UI. Могут быть назначены любым приложениям и группам.

### Системные теги

Управляются автоматически на основе определений в `app/services/system_tags/definitions.py`.

#### Список системных тегов

| Тег | Отображение | Тип триггера | Описание |
|-----|-------------|--------------|----------|
| `haproxy` | H | MAPPING | Приложение связано с HAProxy backend |
| `eureka` | E | MAPPING | Приложение зарегистрировано в Eureka |
| `docker` | docker | APP_TYPE | Docker-контейнер |
| `smf` | smf | APP_TYPE | SMF сервис (Solaris) |
| `sysctl` | sysctl | APP_TYPE | Systemctl сервис |
| `disable` | disable | MANUAL | Отключенное приложение |
| `system` | SYS | MANUAL | Системное приложение |
| `ver.lock` | v.lock | MANUAL | Блокировка обновлений |
| `status.lock` | s.lock | MANUAL | Блокировка start/stop/restart |

---

## Системные теги

### Архитектура системных тегов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        АРХИТЕКТУРА СИСТЕМНЫХ ТЕГОВ                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              DEFINITIONS                                     │
│                        (definitions.py)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────┐    ┌─────────────────────────────────────────────┐ │
│  │    TriggerType      │    │         SystemTagDefinition                 │ │
│  │    (Enum)           │    │         (dataclass)                         │ │
│  ├─────────────────────┤    ├─────────────────────────────────────────────┤ │
│  │ • MANUAL           │    │ • name: str                                 │ │
│  │ • MAPPING          │    │ • display_name: str                         │ │
│  │ • APP_TYPE         │    │ • description: str                          │ │
│  │ • CUSTOM           │    │ • trigger_type: TriggerType                 │ │
│  └─────────────────────┘    │ • show_in_table: bool                       │ │
│                              │ • config_key: Optional[str]                 │ │
│                              │ • mapping_entity_type: Optional[str]        │ │
│                              │ • app_type_value: Optional[str]             │ │
│                              │ • border_color / text_color                 │ │
│                              └─────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        SYSTEM_TAGS Registry                             │ │
│  │  {                                                                      │ │
│  │    'haproxy': SystemTagDefinition(...),                                 │ │
│  │    'eureka':  SystemTagDefinition(...),                                 │ │
│  │    'docker':  SystemTagDefinition(...),                                 │ │
│  │    ...                                                                  │ │
│  │  }                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          SystemTagsService                                   │
│                            (service.py)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Проверки:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ is_enabled()            → Глобальная проверка SYSTEM_TAGS_ENABLED       │ │
│  │ is_tag_enabled(tag_def) → Проверка config_key для конкретного тега      │ │
│  │ is_auto_assign_disabled → Проверка флага на уровне instance+tag         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Триггеры:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ on_mapping_created(instance, entity_type)  → Назначение тега маппинга   │ │
│  │ on_mapping_deleted(instance, entity_type)  → Удаление тега маппинга     │ │
│  │ on_app_synced(instance)                    → Обновление тегов app_type  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Управление:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ assign_tag(instance, tag_name)             → Назначить тег              │ │
│  │ remove_tag(instance, tag_name)             → Удалить тег                │ │
│  │ set_auto_assign_disabled(instance, ...)    → Переключить авто-назначение│ │
│  │ migrate_existing_data()                    → Миграция существующих      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Типы триггеров (TriggerType)

| Триггер | Описание | Когда срабатывает |
|---------|----------|-------------------|
| `MANUAL` | Только ручное назначение | Никогда автоматически |
| `MAPPING` | При создании/удалении маппинга | `on_mapping_created`, `on_mapping_deleted` |
| `APP_TYPE` | На основе типа приложения | `on_app_synced` |
| `CUSTOM` | Произвольная логика | Через callback-функции |

### Логика автоназначения

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ЛОГИКА АВТОНАЗНАЧЕНИЯ ТЕГОВ                               │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────────────┐
                    │   Событие триггера       │
                    │ (mapping/sync/custom)    │
                    └────────────┬─────────────┘
                                 │
                                 ▼
                    ┌──────────────────────────┐
                    │ SYSTEM_TAGS_ENABLED?     │
                    └────────────┬─────────────┘
                                 │
                    ┌────────────┴────────────┐
                    ▼                         ▼
               [Да]                       [Нет]
                    │                         │
                    ▼                         ▼
    ┌───────────────────────────┐    ┌─────────────────┐
    │ trigger_type == MANUAL?   │    │   Пропускаем    │
    └───────────┬───────────────┘    └─────────────────┘
                │
    ┌───────────┴───────────┐
    ▼                       ▼
  [Да]                   [Нет]
    │                       │
    ▼                       ▼
┌────────────┐   ┌────────────────────────┐
│ Пропускаем │   │ config_key существует? │
└────────────┘   └───────────┬────────────┘
                             │
                 ┌───────────┴───────────┐
                 ▼                       ▼
              [Да]                    [Нет]
                 │                       │
                 ▼                       │
      ┌──────────────────────┐           │
      │ getattr(Config, key) │           │
      │     == True?         │           │
      └──────────┬───────────┘           │
                 │                       │
      ┌──────────┴──────────┐            │
      ▼                     ▼            │
   [Да]                  [Нет]           │
      │                     │            │
      │                     ▼            │
      │              ┌────────────┐      │
      │              │ Пропускаем │      │
      │              └────────────┘      │
      │                                  │
      └────────────────┬─────────────────┘
                       │
                       ▼
          ┌─────────────────────────────┐
          │ auto_assign_disabled для    │
          │ этого instance+tag?         │
          └─────────────┬───────────────┘
                        │
            ┌───────────┴───────────┐
            ▼                       ▼
         [Да]                    [Нет]
            │                       │
            ▼                       ▼
     ┌────────────┐    ┌─────────────────────┐
     │ Пропускаем │    │ НАЗНАЧАЕМ/УДАЛЯЕМ   │
     └────────────┘    │ ТЕГ                 │
                       └─────────────────────┘
```

---

## API

### Endpoints для тегов

**Базовый путь:** `/api`

#### CRUD операции с тегами

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/tags` | Список всех тегов (с пагинацией) |
| POST | `/tags` | Создать новый тег |
| GET | `/tags/<id>` | Получить тег по ID |
| PUT | `/tags/<id>` | Обновить тег |
| DELETE | `/tags/<id>` | Удалить тег |

#### Теги приложений (ApplicationInstance)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/applications/<id>/tags` | Теги приложения |
| POST | `/applications/<id>/tags` | Добавить тег к приложению |
| DELETE | `/applications/<id>/tags/<tag_id>` | Удалить тег у приложения |
| GET | `/applications/<id>/system-tags` | Системные теги с info |
| PUT | `/applications/<id>/tags/<tag_id>/auto-assign` | Управление автоназначением |
| GET | `/applications/<id>/tag-history` | История тегов приложения |

#### Теги групп (ApplicationGroup)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/app-groups/<id>/tags` | Теги группы |
| POST | `/app-groups/<id>/tags` | Добавить тег к группе |
| DELETE | `/app-groups/<id>/tags/<tag_id>` | Удалить тег у группы |
| GET | `/app-groups/<id>/tag-history` | История тегов группы |

#### Фильтрация и bulk-операции

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/applications/filter/by-tags` | Фильтрация по тегам (OR/AND) |
| POST | `/tags/bulk-assign` | Массовое назначение/удаление тегов |
| PUT | `/tags/sync` | Синхронизация тегов (установить желаемое состояние) |

#### Статистика и история

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/tags/statistics` | Статистика использования тегов |
| GET | `/tags/<id>/history` | История использования тега |

### Примеры запросов

#### Создание тега

```json
POST /api/tags
{
    "name": "production",
    "display_name": "Production",
    "description": "Продакшен-окружение",
    "tag_type": "env",
    "border_color": "#28a745",
    "text_color": "#28a745"
}
```

#### Фильтрация по тегам

```json
POST /api/applications/filter/by-tags
{
    "tags": ["production", "haproxy"],
    "operator": "AND"
}
```

#### Массовое назначение тегов

```json
POST /api/tags/bulk-assign
{
    "tag_names": ["production", "critical"],
    "target_type": "instances",
    "target_ids": [1, 2, 3, 4, 5],
    "action": "add"
}
```

---

## Фронтенд компоненты

### TagsModal (`app/static/js/applications/modals/tags-modal.js`)

Модуль для управления тегами через модальные окна.

#### Методы

| Метод | Описание |
|-------|----------|
| `showBatchTagsModal(appIds, deps)` | Модалка массового управления тегами для выбранных приложений |
| `showGroupTagsModal(groupId, groupName, deps)` | Модалка управления тегами группы |

#### Особенности

- Отображение partial-состояния для выбранных приложений
- Разделение на кастомные и системные теги
- Метки для унаследованных тегов (от группы)
- Метки для автоназначаемых тегов

### TagsRenderer (`app/static/js/applications/ui/tags-renderer.js`)

Модуль для рендеринга тегов в UI.

#### Методы

| Метод | Описание |
|-------|----------|
| `render(ownTags, options)` | Рендеринг тегов с опциями |

#### Опции

| Опция | Тип | Описание |
|-------|-----|----------|
| `groupTags` | Array | Унаследованные теги от группы |
| `maxVisible` | Number | Максимум видимых тегов (default: 4) |
| `tableMode` | Boolean | Фильтр по `show_in_table` для системных |

---

## Схемы взаимодействия

### 1. Назначение тега через UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    НАЗНАЧЕНИЕ ТЕГА ЧЕРЕЗ UI                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────┐     ┌───────────────┐     ┌────────────────┐     ┌─────────────┐
│   User    │     │  TagsModal    │     │  API Layer     │     │   Database  │
└─────┬─────┘     └───────┬───────┘     └────────┬───────┘     └──────┬──────┘
      │                   │                      │                     │
      │  Открыть модалку  │                      │                     │
      │──────────────────▶│                      │                     │
      │                   │                      │                     │
      │                   │  GET /api/tags       │                     │
      │                   │─────────────────────▶│                     │
      │                   │                      │                     │
      │                   │                      │   SELECT * FROM     │
      │                   │                      │   tags              │
      │                   │                      │────────────────────▶│
      │                   │                      │◀────────────────────│
      │                   │◀─────────────────────│                     │
      │                   │                      │                     │
      │  Показать модалку │                      │                     │
      │◀──────────────────│                      │                     │
      │                   │                      │                     │
      │  Выбрать теги,    │                      │                     │
      │  нажать Apply     │                      │                     │
      │──────────────────▶│                      │                     │
      │                   │                      │                     │
      │                   │  POST /api/tags/     │                     │
      │                   │  bulk-assign         │                     │
      │                   │─────────────────────▶│                     │
      │                   │                      │                     │
      │                   │                      │   INSERT INTO       │
      │                   │                      │   app_instance_tags │
      │                   │                      │────────────────────▶│
      │                   │                      │                     │
      │                   │                      │   INSERT INTO       │
      │                   │                      │   tag_history       │
      │                   │                      │────────────────────▶│
      │                   │                      │                     │
      │                   │                      │   [SQLAlchemy       │
      │                   │                      │    after_flush]     │
      │                   │                      │   UPDATE tags_cache │
      │                   │                      │────────────────────▶│
      │                   │                      │◀────────────────────│
      │                   │◀─────────────────────│                     │
      │                   │                      │                     │
      │  Уведомление      │                      │                     │
      │◀──────────────────│                      │                     │
      │                   │                      │                     │
```

### 2. Автоназначение тега при создании маппинга

```
┌─────────────────────────────────────────────────────────────────────────────┐
│               АВТОНАЗНАЧЕНИЕ ТЕГА ПРИ СОЗДАНИИ МАППИНГА                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────────┐    ┌─────────────────┐    ┌────────────────────┐    ┌────────┐
│ MappingService│    │SystemTagsService│    │     Tag Model      │    │Database│
└───────┬───────┘    └────────┬────────┘    └─────────┬──────────┘    └───┬────┘
        │                     │                       │                    │
        │ Создан маппинг      │                       │                    │
        │ (HAProxy/Eureka)    │                       │                    │
        │                     │                       │                    │
        │ on_mapping_created  │                       │                    │
        │ (instance,          │                       │                    │
        │  'haproxy_server')  │                       │                    │
        │────────────────────▶│                       │                    │
        │                     │                       │                    │
        │                     │ is_enabled()?         │                    │
        │                     │ is_tag_enabled()?     │                    │
        │                     │ is_auto_assign_       │                    │
        │                     │ disabled()?           │                    │
        │                     │                       │                    │
        │                     │ [Все проверки OK]     │                    │
        │                     │                       │                    │
        │                     │ assign_tag(instance,  │                    │
        │                     │   'haproxy',          │                    │
        │                     │   'auto:mapping')     │                    │
        │                     │──────────────────────▶│                    │
        │                     │                       │                    │
        │                     │                       │  INSERT INTO       │
        │                     │                       │  app_instance_tags │
        │                     │                       │───────────────────▶│
        │                     │                       │◀───────────────────│
        │                     │                       │                    │
        │                     │◀──────────────────────│                    │
        │                     │                       │                    │
        │ True                │                       │                    │
        │◀────────────────────│                       │                    │
        │                     │                       │                    │
```

### 3. Наследование тегов от группы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   НАСЛЕДОВАНИЕ ТЕГОВ ОТ ГРУППЫ                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────┐
│    ApplicationGroup     │
│                         │
│ ┌─────────────────────┐ │
│ │ tags: [prod, web]   │ │
│ └─────────────────────┘ │
└───────────┬─────────────┘
            │
            │ group_tags (наследование)
            │
    ┌───────┴───────┬───────────────┐
    │               │               │
    ▼               ▼               ▼
┌────────────┐ ┌────────────┐ ┌────────────┐
│ Instance 1 │ │ Instance 2 │ │ Instance 3 │
│            │ │            │ │            │
│ own: [api] │ │ own: []    │ │ own: [db]  │
│            │ │            │ │            │
│ effective: │ │ effective: │ │ effective: │
│ [api,prod, │ │ [prod,web] │ │ [db,prod,  │
│  web]      │ │            │ │  web]      │
└────────────┘ └────────────┘ └────────────┘

Примечание:
- Собственные теги (own) хранятся в application_instance_tags
- Унаследованные теги (inherited) получаются через group.tags
- В UI унаследованные теги помечаются меткой "(от группы)"
- Унаследованные теги нельзя удалить на уровне instance
```

### 4. Обновление tags_cache через SQLAlchemy Event

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              АВТООБНОВЛЕНИЕ tags_cache (SQLAlchemy Event)                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐     ┌──────────────────────┐     ┌────────────────────────┐
│  Любая операция │     │ SQLAlchemy Session   │     │   Database             │
│  с тегами       │     │                      │     │                        │
└────────┬────────┘     └──────────┬───────────┘     └───────────┬────────────┘
         │                         │                              │
         │  session.add(           │                              │
         │    ApplicationInstanceTag│                             │
         │  )                      │                              │
         │────────────────────────▶│                              │
         │                         │                              │
         │  session.commit()       │                              │
         │────────────────────────▶│                              │
         │                         │                              │
         │                         │  [FLUSH]                     │
         │                         │  INSERT INTO                 │
         │                         │  application_instance_tags   │
         │                         │─────────────────────────────▶│
         │                         │◀─────────────────────────────│
         │                         │                              │
         │                         │  [after_flush event]         │
         │                         │  update_tags_cache_          │
         │                         │  after_flush()               │
         │                         │                              │
         │                         │  SELECT t.name FROM tags...  │
         │                         │─────────────────────────────▶│
         │                         │◀─────────────────────────────│
         │                         │                              │
         │                         │  UPDATE application_instances│
         │                         │  SET tags_cache = 'a,b,c'    │
         │                         │─────────────────────────────▶│
         │                         │◀─────────────────────────────│
         │                         │                              │
         │◀────────────────────────│                              │
         │                         │                              │

Примечание:
- Event listener определён в app/models/tag.py:152
- Использует прямой SQL для избежания рекурсивного flush
- tags_cache содержит отсортированный список имён тегов через запятую
```

### 5. Фильтрация приложений по тегам

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ФИЛЬТРАЦИЯ ПРИЛОЖЕНИЙ ПО ТЕГАМ                            │
└─────────────────────────────────────────────────────────────────────────────┘

                         ┌────────────────────────────┐
                         │        Запрос фильтра      │
                         │ {"tags": ["prod", "web"],  │
                         │  "operator": "AND"}        │
                         └─────────────┬──────────────┘
                                       │
                                       ▼
                         ┌────────────────────────────┐
                         │    Проверка оператора      │
                         └─────────────┬──────────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    ▼                                     ▼
             ┌─────────────┐                       ┌─────────────┐
             │    "OR"     │                       │    "AND"    │
             └──────┬──────┘                       └──────┬──────┘
                    │                                     │
                    ▼                                     ▼
┌───────────────────────────────────┐    ┌──────────────────────────────────┐
│  SQL подзапросы:                  │    │  Python-фильтрация:              │
│                                   │    │                                  │
│  instance_subq = SELECT app_id    │    │  for inst in all_instances:      │
│    FROM app_instance_tags         │    │    all_tags = inst.tags ∪        │
│    JOIN tags WHERE name IN (...)  │    │               inst.group.tags    │
│                                   │    │    if required_tags ⊆ all_tags:  │
│  group_subq = SELECT group_id     │    │      result.append(inst)         │
│    FROM app_group_tags            │    │                                  │
│    JOIN tags WHERE name IN (...)  │    │                                  │
│                                   │    │                                  │
│  WHERE app.id IN instance_subq    │    │                                  │
│     OR app.group_id IN group_subq │    │                                  │
└───────────────────────────────────┘    └──────────────────────────────────┘
                    │                                     │
                    └──────────────────┬──────────────────┘
                                       │
                                       ▼
                         ┌────────────────────────────┐
                         │   Результат: список        │
                         │   отфильтрованных app      │
                         └────────────────────────────┘
```

---

## Конфигурация

### Переменные окружения

| Переменная | Тип | Default | Описание |
|------------|-----|---------|----------|
| `SYSTEM_TAGS_ENABLED` | bool | `true` | Глобальное включение системы тегов |
| `AUTO_TAG_HAPROXY_ENABLED` | bool | `true` | Автотег `haproxy` при маппинге |
| `AUTO_TAG_EUREKA_ENABLED` | bool | `true` | Автотег `eureka` при маппинге |
| `AUTO_TAG_DOCKER_ENABLED` | bool | `true` | Автотег `docker` по app_type |
| `AUTO_TAG_SMF_ENABLED` | bool | `false` | Автотег `smf` по app_type |
| `AUTO_TAG_SYSCTL_ENABLED` | bool | `false` | Автотег `sysctl` по app_type |

### Расширение системы

#### Добавление нового системного тега

1. Добавить определение в `app/services/system_tags/definitions.py`:

```python
SYSTEM_TAGS = {
    # ...
    'my_new_tag': SystemTagDefinition(
        name='my_new_tag',
        display_name='NEW',
        description='Мой новый тег',
        trigger_type=TriggerType.APP_TYPE,  # или MAPPING, MANUAL, CUSTOM
        show_in_table=True,
        config_key='AUTO_TAG_MY_NEW_ENABLED',  # опционально
        app_type_value='my_type',  # для APP_TYPE
        border_color='#ff5733',
        text_color='#ff5733'
    ),
}
```

2. Добавить конфигурацию в `app/config.py` (если нужен config_key):

```python
AUTO_TAG_MY_NEW_ENABLED = os.environ.get('AUTO_TAG_MY_NEW_ENABLED', 'false').lower() == 'true'
```

3. Выполнить миграцию существующих данных:

```python
from app.services.system_tags import SystemTagsService
stats = SystemTagsService.migrate_existing_data()
```

---

## Связанные файлы

| Компонент | Файл |
|-----------|------|
| Модель Tag | `app/models/tag.py` |
| API Routes | `app/api/tags_routes.py` |
| SystemTagsService | `app/services/system_tags/service.py` |
| Tag Definitions | `app/services/system_tags/definitions.py` |
| Tags Modal (JS) | `app/static/js/applications/modals/tags-modal.js` |
| Tags Renderer (JS) | `app/static/js/applications/ui/tags-renderer.js` |
| Миграция | `migrations/add_system_tags.py` |

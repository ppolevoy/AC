# Архитектура опроса агентов и сохранения информации о приложениях

## Общая схема

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ЦИКЛ МОНИТОРИНГА                                   │
│                    (app/tasks/monitoring.py)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    POLLING_INTERVAL    ┌──────────────────────────┐   │
│  │ MonitoringTasks │ ◄──── (60 сек) ──────► │ _run_monitoring()        │   │
│  │ (daemon thread) │                        │ asyncio event loop       │   │
│  └────────┬────────┘                        └──────────────────────────┘   │
│           │                                                                 │
│           ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       _poll_servers()                                │   │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐         ┌─────────┐       │   │
│  │  │Server 1 │   │Server 2 │   │Server 3 │  . . .  │Server N │       │   │
│  │  └────┬────┘   └────┬────┘   └────┬────┘         └────┬────┘       │   │
│  │       │             │             │                   │             │   │
│  │       └─────────────┴──────┬──────┴───────────────────┘             │   │
│  │                            │                                         │   │
│  │                 asyncio.gather(*tasks)                              │   │
│  └────────────────────────────┼────────────────────────────────────────┘   │
│                               │                                             │
└───────────────────────────────┼─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          AGENT SERVICE                                       │
│               (app/services/agent_service.py)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   update_server_applications(server_id)                                     │
│   ═══════════════════════════════════════                                   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 1. check_agent(server)                                              │   │
│   │    └─► HTTP GET http://{ip}:{port}/ping                            │   │
│   │        ├─► 200 OK → server.status = 'online'                       │   │
│   │        └─► Error  → server.status = 'offline'                      │   │
│   │                     apps.status = 'no_data'                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                             │
│                               ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 2. get_applications(server)                                         │   │
│   │    └─► HTTP GET http://{ip}:{port}/api/v1/apps                     │   │
│   │        └─► JSON Response:                                          │   │
│   │            {                                                        │   │
│   │              "server": {                                            │   │
│   │                "docker-app": { "applications": [...] },            │   │
│   │                "site-app": { "applications": [...] },              │   │
│   │                "service-app": { "applications": [...] }            │   │
│   │              }                                                      │   │
│   │            }                                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                             │
│                               ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 3. Обработка Docker приложений                                      │   │
│   │    ┌────────────────────────────────────────────────────────────┐  │   │
│   │    │ Для каждого app_data in docker-app['applications']:       │  │   │
│   │    │  ├─► Поиск ApplicationInstance по (server_id,             │  │   │
│   │    │  │   container_name, app_type='docker')                   │  │   │
│   │    │  ├─► Создание нового или обновление существующего         │  │   │
│   │    │  ├─► Обновление полей:                                    │  │   │
│   │    │  │   • container_id, container_name, compose_project_dir  │  │   │
│   │    │  │   • image, tag, version                                │  │   │
│   │    │  │   • ip, port, pid, start_time                          │  │   │
│   │    │  │   • eureka_url, eureka_registered                      │  │   │
│   │    │  │   • status (нормализуется через _normalize_status)     │  │   │
│   │    │  ├─► _record_version_change() - запись истории версий     │  │   │
│   │    │  └─► ApplicationGroupService.resolve_application_group()  │  │   │
│   │    └────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                             │
│                               ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 4. Обработка Site/Service приложений (аналогично Docker)           │   │
│   │    • Поиск/создание ApplicationInstance                             │   │
│   │    • Поля: path, log_path, version, distr_path, ip, port, status   │   │
│   │    • Запись истории версий и определение группы                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                             │
│                               ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 5. Обработка удаленных приложений                                   │   │
│   │    deleted_app_ids = existing_app_ids - updated_app_ids            │   │
│   │    └─► Для каждого: instance.status = 'offline'                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                             │
│                               ▼                                             │
│                      db.session.commit()                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Определение групп приложений

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  APPLICATION GROUP SERVICE                                   │
│          (app/services/application_group_service.py)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   resolve_application_group(instance)                                       │
│   ═══════════════════════════════════                                       │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 1. parse_application_name(instance_name)                            │   │
│   │    ┌──────────────────────────────────────────────────────────┐    │   │
│   │    │  Паттерн: ^(.+?)_(\d+)$                                   │    │   │
│   │    │                                                           │    │   │
│   │    │  Примеры:                                                 │    │   │
│   │    │  • "jurws_1"      → ("jurws", 1)                         │    │   │
│   │    │  • "best-app_2"   → ("best-app", 2)                      │    │   │
│   │    │  • "standalone"   → ("standalone", 0)                    │    │   │
│   │    │  • "my-app_test"  → ("my-app_test", 0)                   │    │   │
│   │    └──────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                             │
│                               ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 2. get_or_create_catalog(base_name, app_type)                       │   │
│   │    ┌──────────────────────────────────────────────────────────┐    │   │
│   │    │  ApplicationCatalog.query.filter_by(name=base_name)      │    │   │
│   │    │  ├─► Найден → возвращаем существующий                    │    │   │
│   │    │  └─► Не найден → создаем новый                          │    │   │
│   │    │                  catalog = ApplicationCatalog(           │    │   │
│   │    │                      name=base_name,                     │    │   │
│   │    │                      app_type=app_type                   │    │   │
│   │    │                  )                                       │    │   │
│   │    └──────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                             │
│                               ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 3. get_or_create_group(group_name, catalog)                         │   │
│   │    ┌──────────────────────────────────────────────────────────┐    │   │
│   │    │  ApplicationGroup.query.filter_by(name=group_name)       │    │   │
│   │    │  ├─► Найдена → возвращаем (+ связываем с каталогом)     │    │   │
│   │    │  └─► Не найдена → создаем новую                         │    │   │
│   │    │                   group = ApplicationGroup(              │    │   │
│   │    │                       name=group_name,                   │    │   │
│   │    │                       catalog_id=catalog.id              │    │   │
│   │    │                   )                                      │    │   │
│   │    └──────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                             │
│                               ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 4. Связывание экземпляра                                            │   │
│   │    instance.catalog_id = catalog.id                                 │   │
│   │    instance.group_id = group.id                                     │   │
│   │    instance.instance_number = instance_number                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Модель данных

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           DATA MODELS                                        │
│                        (app/models/*.py)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────────┐         ┌────────────────────────┐                  │
│   │      Server      │         │  ApplicationCatalog    │                  │
│   ├──────────────────┤         ├────────────────────────┤                  │
│   │ id               │         │ id                     │                  │
│   │ name             │         │ name (unique)          │ ◄─ "jurws"       │
│   │ ip               │         │ app_type               │                  │
│   │ port             │         │ description            │                  │
│   │ status           │         │ default_playbook_path  │                  │
│   │ last_check       │         │ default_artifact_url   │                  │
│   │ is_haproxy_node  │         │ default_artifact_ext   │                  │
│   │ is_eureka_node   │         └───────────┬────────────┘                  │
│   └────────┬─────────┘                     │                               │
│            │                               │ 1:N                            │
│            │ 1:N                           ▼                               │
│            │              ┌────────────────────────────┐                   │
│            │              │    ApplicationGroup        │                   │
│            │              ├────────────────────────────┤                   │
│            │              │ id                         │                   │
│            │              │ name (unique)              │ ◄─ "jurws"        │
│            │              │ catalog_id ───────────────►│                   │
│            │              │ artifact_list_url          │                   │
│            │              │ artifact_extension         │                   │
│            │              │ update_playbook_path       │                   │
│            │              │ batch_grouping_strategy    │                   │
│            │              │ tags_cache                 │                   │
│            │              └───────────┬────────────────┘                   │
│            │                          │                                    │
│            │                          │ 1:N                                │
│            ▼                          ▼                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    ApplicationInstance                               │  │
│   ├─────────────────────────────────────────────────────────────────────┤  │
│   │ id                    │ catalog_id ──────────────────────────────► │  │
│   │ server_id ───────────►│ group_id ────────────────────────────────► │  │
│   │ instance_name         │  "jurws_1", "jurws_2"                       │  │
│   │ instance_number       │  1, 2, 3...                                 │  │
│   │ app_type              │  docker | site | service | eureka           │  │
│   │ status                │  online | offline | unknown | no_data       │  │
│   ├─────────────────────────────────────────────────────────────────────┤  │
│   │ Docker-специфичные:   │ Site/Service-специфичные:                   │  │
│   │ • container_id        │ • path                                      │  │
│   │ • container_name      │ • log_path                                  │  │
│   │ • compose_project_dir │ • version                                   │  │
│   │ • image               │ • distr_path                                │  │
│   │ • tag                 │                                             │  │
│   │ • eureka_registered   │                                             │  │
│   ├─────────────────────────────────────────────────────────────────────┤  │
│   │ Кастомизация:                                                       │  │
│   │ • custom_playbook_path                                              │  │
│   │ • custom_artifact_url                                               │  │
│   │ • custom_artifact_extension                                         │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│            │                                                               │
│            │ 1:N                                                           │
│            ▼                                                               │
│   ┌────────────────────────┐    ┌──────────────────────────────┐          │
│   │         Event          │    │ ApplicationVersionHistory    │          │
│   ├────────────────────────┤    ├──────────────────────────────┤          │
│   │ id                     │    │ id                           │          │
│   │ timestamp              │    │ instance_id ─────────────────┤          │
│   │ event_type             │    │ old_version                  │          │
│   │  • start               │    │ new_version                  │          │
│   │  • stop                │    │ old_distr_path               │          │
│   │  • restart             │    │ new_distr_path               │          │
│   │  • update              │    │ old_tag, new_tag             │          │
│   │  • connect             │    │ old_image, new_image         │          │
│   │  • disconnect          │    │ changed_at                   │          │
│   │ description            │    │ changed_by (user|agent)      │          │
│   │ status                 │    │ change_source                │          │
│   │ server_id              │    │  • update_task               │          │
│   │ instance_id            │    │  • polling                   │          │
│   └────────────────────────┘    │  • manual                    │          │
│                                 │ task_id                      │          │
│                                 │ notes                        │          │
│                                 └──────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Нормализация статусов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        STATUS NORMALIZATION                                  │
│                 (_normalize_status в agent_service.py)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Разрешённые статусы:                                                      │
│   ┌────────────────────────────────────────────────────────────────────┐   │
│   │  online  │  offline  │  unknown  │  starting  │  stopping  │ no_data │   │
│   └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Маппинг нестандартных статусов:                                          │
│   ┌─────────────────────┬──────────────────────┐                           │
│   │ От агента           │ Нормализованный      │                           │
│   ├─────────────────────┼──────────────────────┤                           │
│   │ disabled            │ offline              │                           │
│   │ enabled             │ online               │                           │
│   │ running             │ online               │                           │
│   │ stopped             │ offline              │                           │
│   │ down                │ offline              │                           │
│   │ up                  │ online               │                           │
│   │ active              │ online               │                           │
│   │ inactive            │ offline              │                           │
│   │ paused              │ stopping             │                           │
│   │ pending             │ starting             │                           │
│   │ (неизвестный)       │ unknown              │                           │
│   │ (null/пустой)       │ unknown              │                           │
│   └─────────────────────┴──────────────────────┘                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Приоритеты настроек (Playbook Path)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     PLAYBOOK PATH RESOLUTION                                 │
│           (ApplicationInstance.get_effective_playbook_path)                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Приоритет (от высшего к низшему):                                        │
│                                                                             │
│   1. instance.custom_playbook_path      ◄── Индивидуальная настройка       │
│              │                               экземпляра                     │
│              ▼                                                              │
│   2. group.update_playbook_path         ◄── Настройка группы               │
│              │                                                              │
│              ▼                                                              │
│   3. catalog.default_playbook_path      ◄── Настройка из каталога          │
│              │                                                              │
│              ▼                                                              │
│   4. Config.DEFAULT_UPDATE_PLAYBOOK     ◄── Глобальный дефолт              │
│              │                               (/etc/ansible/update-app.yml)  │
│              ▼                                                              │
│        Итоговый путь к playbook                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Запись истории версий

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      VERSION HISTORY RECORDING                               │
│                  (_record_version_change в agent_service.py)                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Условия записи:                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ • instance.id существует (не новый экземпляр)                       │   │
│   │ • old_version != new_version ИЛИ old_tag != new_tag                 │   │
│   │ • new_version или new_tag не пустые                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌──────────────────────────────┐    ┌──────────────────────────────┐     │
│   │      Polling (Agent)          │    │      Update Task (User)      │     │
│   ├──────────────────────────────┤    ├──────────────────────────────┤     │
│   │ changed_by: 'agent'          │    │ changed_by: 'user'           │     │
│   │ change_source: 'polling'     │    │ change_source: 'update_task' │     │
│   │ task_id: None                │    │ task_id: '<task_uuid>'       │     │
│   └──────────────────────────────┘    └──────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Жизненный цикл данных при опросе

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       DATA LIFECYCLE DURING POLLING                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                          FAgent                                    │    │
│   │                    (удалённый сервер)                             │    │
│   └──────────────────────────┬────────────────────────────────────────┘    │
│                              │ HTTP GET /api/v1/apps                       │
│                              ▼                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                       AgentService                                 │    │
│   │   ┌─────────────────────────────────────────────────────────┐     │    │
│   │   │ Обработка JSON ответа                                    │     │    │
│   │   │ • docker-app.applications[]                              │     │    │
│   │   │ • site-app.applications[]                                │     │    │
│   │   │ • service-app.applications[]                             │     │    │
│   │   └─────────────────────────────────────────────────────────┘     │    │
│   └──────────────────────────┬────────────────────────────────────────┘    │
│                              │                                             │
│                              ▼                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │              Для каждого приложения из ответа                      │    │
│   │   ┌─────────────────────────────────────────────────────────┐     │    │
│   │   │ 1. Поиск существующего ApplicationInstance               │     │    │
│   │   │    filter_by(server_id, instance_name, app_type)        │     │    │
│   │   │                                                          │     │    │
│   │   │ 2. Создание нового или обновление существующего          │     │    │
│   │   │                                                          │     │    │
│   │   │ 3. Обновление полей из данных агента                    │     │    │
│   │   │                                                          │     │    │
│   │   │ 4. Запись истории версий (если версия изменилась)       │     │    │
│   │   │    └─► ApplicationVersionHistory                         │     │    │
│   │   │                                                          │     │    │
│   │   │ 5. Определение группы                                    │     │    │
│   │   │    └─► ApplicationGroupService.resolve_application_group │     │    │
│   │   │        ├─► parse_application_name()                     │     │    │
│   │   │        ├─► get_or_create_catalog()                      │     │    │
│   │   │        └─► get_or_create_group()                        │     │    │
│   │   │                                                          │     │    │
│   │   │ 6. Добавление ID в updated_app_ids                      │     │    │
│   │   └─────────────────────────────────────────────────────────┘     │    │
│   └──────────────────────────┬────────────────────────────────────────┘    │
│                              │                                             │
│                              ▼                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │              Обработка удалённых приложений                        │    │
│   │   ┌─────────────────────────────────────────────────────────┐     │    │
│   │   │ deleted_ids = existing_app_ids - updated_app_ids        │     │    │
│   │   │                                                          │     │    │
│   │   │ Для каждого deleted_id:                                 │     │    │
│   │   │   instance.status = 'offline'                           │     │    │
│   │   │   instance.last_seen = now()                            │     │    │
│   │   └─────────────────────────────────────────────────────────┘     │    │
│   └──────────────────────────┬────────────────────────────────────────┘    │
│                              │                                             │
│                              ▼                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                     db.session.commit()                            │    │
│   │                                                                    │    │
│   │  Записываются изменения в таблицы:                                │    │
│   │  • servers (status, last_check)                                   │    │
│   │  • application_instances (все поля)                               │    │
│   │  • application_catalog (если создан новый)                        │    │
│   │  • application_groups (если создана новая)                        │    │
│   │  • application_version_history (если версия изменилась)           │    │
│   │  • events (если статус сервера изменился)                         │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Конфигурация

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| `POLLING_INTERVAL` | Интервал опроса серверов | 60 сек |
| `CONNECTION_TIMEOUT` | Таймаут HTTP запросов к агенту | настраивается |
| `DEFAULT_UPDATE_PLAYBOOK` | Путь к playbook по умолчанию | /etc/ansible/update-app.yml |
| `CLEAN_EVENTS_OLDER_THAN` | Хранить события не старше N дней | настраивается |
| `CLEAN_TASKS_OLDER_THAN` | Хранить задачи не старше N дней | настраивается |

## Используемые компоненты

### Сервисы

| Файл | Класс/Функция | Назначение |
|------|---------------|------------|
| `app/services/agent_service.py` | `AgentService` | HTTP-взаимодействие с FAgent |
| `app/services/agent_service.py` | `_normalize_status()` | Нормализация статусов |
| `app/services/agent_service.py` | `_record_version_change()` | Запись истории версий |
| `app/services/application_group_service.py` | `ApplicationGroupService` | Управление группами и каталогом |

### Модели

| Файл | Модель | Назначение |
|------|--------|------------|
| `app/models/server.py` | `Server` | Сервер с FAgent |
| `app/models/application_instance.py` | `ApplicationInstance` | Экземпляр приложения |
| `app/models/application_group.py` | `ApplicationGroup` | Группа приложений |
| `app/models/application_catalog.py` | `ApplicationCatalog` | Справочник типов приложений |
| `app/models/application_version_history.py` | `ApplicationVersionHistory` | История версий |
| `app/models/event.py` | `Event` | Журнал событий |

### Задачи мониторинга

| Файл | Класс/Функция | Назначение |
|------|---------------|------------|
| `app/tasks/monitoring.py` | `MonitoringTasks` | Управление циклом мониторинга |
| `app/tasks/monitoring.py` | `_poll_servers()` | Асинхронный опрос всех серверов |
| `app/tasks/monitoring.py` | `_clean_old_events()` | Очистка старых событий |
| `app/tasks/monitoring.py` | `init_monitoring()` | Инициализация при старте приложения |

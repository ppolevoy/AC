# Рефакторинг Orchestrator Playbooks — План выполнения

## ОБЩАЯ ЦЕЛЬ

**Декомпозиция God Method `_process_update_task` в `queue.py`**

| Метрика | Было | Цель | Текущее |
|---------|------|------|---------|
| Строк в `_process_update_task` | 339 | ~80 | ~98 ✓ |
| Строк в `update_application` | 195 | ~40 | ~80 ✓ |
| Дублирование парсинга | 2 места | 1 место | 1 место ✓ |
| Магические числа | 11 | 0 | 0 ✓ |
| Dead code | ~600 строк | 0 | 0 ✓ |

## РЕШАЕМАЯ ЗАДАЧА

Устранить архитектурные проблемы системы Orchestrator Playbooks:

1. **P1: Дублирование парсинга** — ✓ РЕШЕНО (единая модель `PlaybookParameterParser`)
2. **P2: Inconsistent boolean** — ✓ РЕШЕНО (всегда string "true"/"false")
3. **P3: Магические числа** — ✓ РЕШЕНО (константы в `config.py`)
4. **P4: God Method 339 строк** — ✓ РЕШЕНО (~98 строк через `UpdateTaskContextProvider` + `OrchestratorExecutor`)
5. **P6: Ping-pong данных** — ✓ РЕШЕНО (prepare/execute/finalize в ssh_ansible_service)
6. **P8: Смешение уровней абстракции** — ✓ РЕШЕНО (декомпозиция на слои)

## ✅ КРИТИЧЕСКАЯ ПРОБЛЕМА РЕШЕНА

Файлы теперь **ИСПОЛЬЗУЮТСЯ** в `queue.py`:
- `app/services/orchestrator_executor.py` — импортируется на строке 821
- `app/services/update_task_context.py` — импортируется на строке 804

---

# ПРОПУЩЕННЫЕ ЭТАПЫ

---

## ЭТАП 2.3: Рефакторинг ssh_ansible_service.py

### Цель этапа
Декомпозиция метода `update_application()` (195 строк → 3 метода)

### TODO

- [x] Прочитать текущую реализацию `update_application()` в `ssh_ansible_service.py`
- [x] Создать приватный метод `_prepare_update_context()` — подготовка контекста (137 строк)
- [x] Создать приватный метод `_finalize_update_result()` — финализация результата (51 строка)
- [x] Упростить `update_application()` до ~80 строк (prepare → execute → finalize)
- [x] Проверить синтаксис Python
- [x] Проверить работу через UI ✓

### Файлы для изменения
- `app/services/ssh_ansible_service.py` (строки 460-654)

### Ожидаемый результат
- Метод `update_application`: 195 → ~40 строк
- Чёткое разделение prepare/execute/finalize

---

> **⚠️ ПОСЛЕ ЗАВЕРШЕНИЯ ЭТАПА 2.3:**
> 1. Сверься с общей целью — приближает ли это к декомпозиции `_process_update_task`?
> 2. Проверь, не создан ли dead code
> 3. Убедись, что изменения интегрированы

---

## ЭТАП 2.4: Тесты для OrchestratorExecutor

### Цель этапа
Покрыть тестами новые классы перед интеграцией

### TODO

- [x] Создать файл `tests/test_orchestrator_executor.py`
- [x] Написать тест `test_haproxy_executor_prepare()` — подготовка параметров HAProxy
- [x] Написать тест `test_simple_executor_prepare()` — подготовка без HAProxy
- [x] Написать тест `test_factory_selects_correct_executor()` — выбор executor по типу
- [x] Написать тест `test_sort_instances_for_batches()` — сортировка для EVEN/ODD
- [x] Запустить тесты: 47 passed ✓

### Файлы для создания
- `tests/test_orchestrator_executor.py`

### Ожидаемый результат
- Минимум 4 теста для executor'ов
- Все тесты проходят

---

> **⚠️ ПОСЛЕ ЗАВЕРШЕНИЯ ЭТАПА 2.4:**
> 1. Сверься с общей целью — тесты нужны для безопасной интеграции
> 2. Убедись что `orchestrator_executor.py` готов к интеграции
> 3. Проверь что тесты покрывают критические пути

---

## ЭТАП 3.1: Интеграция в queue.py (ГЛАВНЫЙ ЭТАП)

### Цель этапа
Интегрировать `OrchestratorExecutor` и `UpdateTaskContextProvider` в `_process_update_task`

**ЭТО ГЛАВНАЯ ЦЕЛЬ ВСЕГО РЕФАКТОРИНГА!**

### TODO

- [x] Прочитать текущую реализацию `_process_update_task()` в `queue.py`
- [x] Определить границы кода для замены на `UpdateTaskContextProvider`
- [x] Заменить загрузку контекста на `UpdateTaskContextProvider.load()`
- [x] Определить границы кода для замены на `OrchestratorExecutor`
- [x] Заменить логику оркестрации на `create_orchestrator_executor()`
- [x] Вызвать `executor.prepare()` для получения параметров
- [x] Удалить inline-логику, которая теперь в executor'ах
- [x] Упростить `_process_update_task()` до ~100 строк (было 342, стало ~98)
- [x] Проверить что все тесты проходят (47 passed)
- [x] Проверить работу через UI с HAProxy orchestrator ✓
- [x] Проверить работу через UI без orchestrator ✓

### Файлы для изменения
- `app/tasks/queue.py` (строки 791-1129)

### Ожидаемый результат
- Метод `_process_update_task`: 339 → ~80 строк
- `OrchestratorExecutor` и `UpdateTaskContextProvider` ИСПОЛЬЗУЮТСЯ
- Нет dead code

---

> **⚠️ ПОСЛЕ ЗАВЕРШЕНИЯ ЭТАПА 3.1:**
> 1. Сверься с общей целью — **ЭТО ГЛАВНАЯ МЕТРИКА**: 339 → ~80 строк
> 2. Проверь что файлы `orchestrator_executor.py` и `update_task_context.py` больше не dead code
> 3. Измерь фактическое количество строк в `_process_update_task`
> 4. Протестируй все сценарии: batch/single, с orchestrator/без

---

## ЭТАП 4.1: Удаление дублирующего кода

### Цель этапа
Удалить устаревший код после успешной интеграции

### TODO

- [x] Убедиться что этап 3.1 полностью завершён и протестирован
- [x] Обновить `parse_playbook_config()` для использования нового парсера внутри (адаптер)
- [x] Оставить `PlaybookParameter` и `PlaybookConfig` для обратной совместимости с API
- [x] Добавить DEPRECATED пометки в docstrings старых классов
- [x] Проверить что нет broken imports
- [x] Запустить все тесты (47 passed)

### Файлы для изменения
- `app/services/ssh_ansible_service.py` (удалить ~100 строк)

### Ожидаемый результат
- Нет дублирующего кода парсинга
- ~100 строк удалено
- Все тесты проходят

---

> **⚠️ ПОСЛЕ ЗАВЕРШЕНИЯ ЭТАПА 4.1:**
> 1. Сверься с общей целью — код должен быть чище
> 2. Проверь что удалённый код нигде не используется
> 3. Запусти полный набор тестов

---

## ЭТАП 4.2: Type hints и docstrings

### Цель этапа
Улучшить документированность новых компонентов

### TODO

- [x] Добавить type hints в `app/core/playbook_parameters.py` — УЖЕ ЕСТЬ
- [x] Добавить type hints в `app/services/orchestrator_executor.py` — УЖЕ ЕСТЬ
- [x] Добавить type hints в `app/services/update_task_context.py` — УЖЕ ЕСТЬ
- [x] Добавить/улучшить docstrings для публичных методов — ВСЕ ЕСТЬ
- [ ] Опционально: запустить mypy для проверки типов

### Файлы для изменения
- `app/core/playbook_parameters.py`
- `app/services/orchestrator_executor.py`
- `app/services/update_task_context.py`

### Ожидаемый результат
- 100% type hints в новых файлах
- Docstrings для всех публичных методов

---

> **⚠️ ПОСЛЕ ЗАВЕРШЕНИЯ ЭТАПА 4.2:**
> 1. Сверься с общей целью — финальная проверка всех метрик
> 2. Обнови чеклист в плане `/root/.claude/plans/soft-skipping-dragonfly.md`

---

# ПОРЯДОК ВЫПОЛНЕНИЯ

```
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 2.3: Рефакторинг ssh_ansible_service.py              │
│  [✓] Декомпозиция update_application()                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼ СВЕРКА С ПЛАНОМ ✓
                      │
┌─────────────────────┴───────────────────────────────────────┐
│  ЭТАП 2.4: Тесты для OrchestratorExecutor                  │
│  [✓] tests/test_orchestrator_executor.py                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼ СВЕРКА С ПЛАНОМ ✓
                      │
┌─────────────────────┴───────────────────────────────────────┐
│  ЭТАП 3.1: Интеграция в queue.py ⭐ ГЛАВНЫЙ                │
│  [✓] _process_update_task: 339 → ~98 строк                  │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼ СВЕРКА С ПЛАНОМ + ТЕСТИРОВАНИЕ ✓
                      │
┌─────────────────────┴───────────────────────────────────────┐
│  ЭТАП 4.1: Удаление дублирующего кода                      │
│  [✓] Адаптер для обратной совместимости                     │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼ СВЕРКА С ПЛАНОМ ✓
                      │
┌─────────────────────┴───────────────────────────────────────┐
│  ЭТАП 4.2: Type hints и docstrings                         │
│  [✓] Финализация документации                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼ ФИНАЛЬНАЯ ПРОВЕРКА ✓
                      │
                   ✅ ГОТОВО
```

---

# ЧЕКЛИСТ ФИНАЛЬНОЙ ПРОВЕРКИ

После всех этапов проверить:

- [x] `_process_update_task` ≤ 100 строк (цель ~80, факт ~98)
- [x] `update_application` ≤ 80 строк (цель ~40, факт ~80 с docstrings)
- [x] `orchestrator_executor.py` используется в `queue.py` (строка 821)
- [x] `update_task_context.py` используется в `queue.py` (строка 804)
- [x] Нет dead code — оба файла интегрированы
- [x] Все тесты проходят: `pytest tests/ -v` (47 passed)
- [x] UI работает: создание задачи с orchestrator ✓
- [x] UI работает: создание задачи без orchestrator ✓
- [x] Boolean параметры корректно передаются в Ansible (playbooks используют `| bool`)
